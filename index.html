<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Gestión de Residuos Sólidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <style>
    /* Estilos Generales y Navbar */
    body { background-color: #f8f9fa; }
    .navbar-brand-custom { font-size: 1.4rem; font-weight: bold; }
    .navbar { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }

    /* Estilo para enlaces restringidos */
    .nav-link.restricted-nav {
      color: #ccc !important; /* Gris claro */
      cursor: pointer;
    }
    .nav-link.restricted-nav:hover {
        color: #888 !important; 
    }

    /* Panel Lateral */
    #editSidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 280px;
      padding-top: 60px;
      z-index: 1040;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      background: #f4f4f4;
      transition: all 0.2s ease-in-out;
      font-size: 0.9rem;
    }
    .sidebar-section { padding: 10px 0; border-bottom: 1px solid #e9ecef; }
    .sidebar-section:last-child { border-bottom: none; }
    .sidebar-heading { color: #007bff; font-size: 0.95rem; margin-bottom: 0.5rem; display: flex; align-items: center; }
    .sidebar-heading i { margin-right: 8px; }

    /* Contenedor Principal */
    .d-none-temp { display: none !important; }
    .section-content { display: none; padding-top: 20px; } 
    #section-inicio { display: block; padding-top: 0; }
    #mainContentWrapper { transition: margin-left .2s ease; }
    #mainContent {
        position: relative;
        max-width: 1400px;
        padding-bottom: 50px; 
    }
    
    /* Hero Section - Diseño Profesional */
    .hero-section {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 50px 30px; 
        border-radius: 12px;
        margin-bottom: 40px;
        text-align: center;
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .hero-title {
        font-size: 2.5rem; 
        font-weight: 700;
        margin-bottom: 15px;
    }
    .hero-subtitle {
        font-size: 1.2rem; 
        max-width: 900px;
        margin: 0 auto;
        line-height: 1.7;
        opacity: 0.9;
    }

    /* Cards - Diseño más limpio */
    .card {
        height: 100%;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        cursor: pointer; 
        position: relative;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .card-body {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        color: #343a40 !important;
    }
    .card-title { font-weight: 600; font-size: 1.15rem; }
    .card-text { font-size: 0.9rem; opacity: 0.8; }

    /* Cards con fondo oscuro */
    .card.text-white .card-body { color: white !important; }
    .card.text-white .card-text { opacity: 0.9; }

    /* Estilo para tarjetas restringidas */
    .card.restricted {
        filter: grayscale(0.7) brightness(0.8);
        position: relative;
        overflow: hidden;
    }
    .card.restricted::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1;
    }
    .card.restricted .card-body {
        position: relative;
        z-index: 2;
    }
    .card.restricted .restricted-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 3;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 10px;
    }
    .card.restricted:hover .restricted-overlay {
        opacity: 1;
    }
    .card.restricted .restricted-overlay i {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    /* Layout de Tarjetas en secciones internas */
    .section-content:not(#section-inicio) .cards-row {
        position: relative; 
        display: block; 
        min-height: 200px; 
        margin-top: 0;
    }
    .movable-card-wrapper {
        position: absolute; 
        width: 48%; 
        min-height: 150px;
        cursor: move !important;
        padding: 0;
    }
    .movable-card-wrapper .card {
        margin: 0 !important; 
        height: 100% !important;
        transform: none !important; 
    }

    /* Estilos de Edición */
    .active-editable { outline: 2px dashed #007bff; }

    /* Movable Text Box */
    .movable {
        position: absolute !important;
        z-index: 1000;
        border: none !important; 
        cursor: default !important;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .movable.active-editable {
        border: 2px dashed #007bff !important;
        cursor: move !important;
    }
    .movable[contenteditable="true"] {
        cursor: text !important;
        outline: 2px dashed #28a745;
    }
    .text-box {
        padding: 15px;
        min-width: 200px;
        min-height: 100px;
    }
    .text-box p { margin: 0; } 
    
    /* Cleanup para evitar saltos en texto estático */
    .editable-text:not([contenteditable="true"]):not(.movable) {
        border: 1px solid transparent !important; 
        padding: 5px;                           
        cursor: default;
    }
    .editable-text[contenteditable="true"]:not(.movable) {
        border: 1px dashed #ccc !important;
        padding: 5px; 
        cursor: text;
        outline: none !important; 
    }
    .hero-title.editable-text,
    .hero-subtitle.editable-text {
        padding: 5px !important;
        border: 1px solid transparent !important;
    }
    .hero-title.editable-text[contenteditable="true"],
    .hero-subtitle.editable-text[contenteditable="true"] {
        border: 1px dashed rgba(255, 255, 255, 0.5) !important;
        border-radius: 5px;
        padding: 5px !important;
    }
    
    /* Grid de tarjetas de inicio */
    .cards-row {
        --bs-gutter-x: 1.5rem;
        --bs-gutter-y: 1.5rem;
        display: flex;
        flex-wrap: wrap;
    }
    .cards-row > .col {
        flex: 0 0 auto;
        width: 20%; 
        padding: calc(var(--bs-gutter-x) * .5);
        margin-top: var(--bs-gutter-y);
    }
  </style>
</head>
<body>
  <div id="editSidebar" class="bg-light d-none-temp p-3 shadow-sm" aria-hidden="true">
    <h5 class="text-primary mb-4"><i class="fas fa-tools"></i> Herramientas de Edición</h5>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-layer-group"></i> Elementos</h6>
        
        <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="addRandomColoredCard()">
          <i class="fas fa-credit-card me-1"></i> Añadir Tarjeta
        </button>

        <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="addTextBox()">
          <i class="fas fa-square-plus me-1"></i> Agregar Cuadro de Texto
        </button>
        <button class="btn btn-sm btn-outline-danger w-100 mb-4" onclick="deleteSelectedElement()">
          <i class="fas fa-trash me-1"></i> Eliminar Seleccionado
        </button>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-arrows-alt"></i> Posición y Tamaño</h6>
        <label class="form-label small fw-bold">Posición (px)</label>
        <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">X</span>
            <input type="number" id="posLeftInput" class="form-control" min="0" oninput="changePosition('left', this.value)">
            <span class="input-group-text">Y</span>
            <input type="number" id="posTopInput" class="form-control" min="0" oninput="changePosition('top', this.value)">
        </div>
        <label class="form-label small fw-bold">Dimensiones (px)</label>
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Ancho</span>
            <input type="number" id="widthInput" class="form-control" min="50" oninput="changeSize('width', this.value)">
            <span class="input-group-text">Alto</span>
            <input type="number" id="heightInput" class="form-control" min="30" oninput="changeSize('height', this.value)">
        </div>
        <div class="alert alert-info py-1 small">
          Mueve con **flechas** (↑↓←→) para precisión de 1px.
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-font"></i> Formato</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('bold')" title="Negrita"><i class="fas fa-bold"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('italic')" title="Cursiva"><i class="fas fa-italic"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('underline')" title="Subrayado"><i class="fas fa-underline"></i></button>
          <button class="btn btn-sm btn-outline-primary" onclick="addLink()" title="Añadir enlace"><i class="fas fa-link"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-align-left"></i> Alineación</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyLeft')"><i class="fas fa-align-left"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyCenter')"><i class="fas fa-align-center"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyRight')"><i class="fas fa-align-right"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyFull')"><i class="fas fa-align-justify"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-list-ul"></i> Listas</h6>
        <div class="btn-group w-100 mb-4" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Viñetas"><i class="fas fa-list-ul"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Numeración"><i class="fas fa-list-ol"></i></button>
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-palette"></i> Estilos Visuales</h6>
        
        <label class="form-label small fw-bold">Tipo de Letra</label>
        <select class="form-select form-select-sm mb-3" id="fontFamilySelect" onchange="changeStyle('fontFamily', this.value)">
          <option value="Arial" style="font-family:Arial">Arial</option>
          <option value="Helvetica" style="font-family:Helvetica">Helvetica</option>
          <option value="Times New Roman" style="font-family:'Times New Roman'">Times New Roman</option>
          <option value="Courier New" style="font-family:'Courier New'">Courier New</option>
          <option value="Verdana" style="font-family:Verdana">Verdana</option>
          <option value="Georgia" style="font-family:Georgia">Georgia</option>
        </select>
        
        <label class="form-label small fw-bold">Tamaño de Fuente</label>
        <div class="input-group input-group-sm mb-3">
          <input type="number" id="fontSizeInput" class="form-control" min="8" max="128" placeholder="Ej: 16"
                 oninput="changeStyle('fontSize', this.value)"> 
          <span class="input-group-text">px</span>
        </div>

        <label class="form-label small fw-bold">Color de Texto</label>
        <input type="color" class="form-control form-control-sm mb-3"
               onchange="changeStyle('color', this.value)">

        <label class="form-label small fw-bold">Fondo</label>
        <input type="color" class="form-control form-control-sm mb-4"
               onchange="changeStyle('hiliteColor', this.value)"> 
    </div>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-history"></i> Historial</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('undo')" title="Deshacer"><i class="fas fa-undo"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('redo')" title="Rehacer"><i class="fas fa-redo"></i></button>
        </div>
    </div>

  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand text-success navbar-brand-custom" href="#" onclick="showSection('inicio')">
        <i class="fas fa-recycle me-2"></i> Gestión Sostenible
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('inicio')">Inicio</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('metas')">Metas <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('indicadores')">Indicadores</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('avances')">Avances <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('reportes')">Reportes <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('formularios')">Formularios</a></li>
        </ul>
        <ul class="navbar-nav" id="loginBtnContainer">
          <li class="nav-item">
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
            </button>
          </li>
        </ul>
        <ul class="navbar-nav d-none" id="userNav">
          <li class="nav-item">
            <button id="editToggleBtn" class="btn btn-outline-primary me-2" onclick="toggleEditMode()">
              <i class="fas fa-edit me-1"></i> Modo Edición
            </button>
          </li>
          <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-bell"></i></a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i> <span id="userNameDisplay">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Gestión de Usuarios</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-address-card me-2"></i> Mi Perfil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="mainContentWrapper" class="container-fluid" style="margin-left:0;">
    <div class="container mt-4" id="mainContent">
      
      <div id="section-inicio" class="section-content">
        <div class="hero-section">
          <h1 class="hero-title editable-text" id="heroTitle">Sistema de Gestión de Residuos Sólidos</h1>
          <p class="hero-subtitle editable-text" id="heroSubtitle">
            La plataforma para monitorear indicadores, gestionar metas y generar reportes para una gestión ambiental eficiente.
          </p>
        </div>

        <div class="cards-row mt-3"> 
          <div class="col">
            <div class="card text-white restricted" style="background-color: #5d6d7e;" data-card-link="#metas"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Metas</h5>
                <p class="card-text editable-text text-white">Definición de objetivos a corto y largo plazo para la reducción de residuos.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background-color: #4CAF50;" data-card-link="#indicadores"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Indicadores</h5>
                <p class="card-text editable-text text-white">Métricas clave para medir el éxito del plan de gestión.</p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card restricted" style="background-color: #f4d03f; color: #343a40;" data-card-link="#avances"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #343a40;">Avances</h5>
                <p class="card-text editable-text" style="color: #343a40;">Registro del progreso y cumplimiento de las metas establecidas.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white restricted" style="background-color: #3498db;" data-card-link="#reportes"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Reportes</h5>
                <p class="card-text editable-text text-white">Generación automática de informes de impacto y sostenibilidad.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background-color: #e74c3c;" data-card-link="#formularios"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Formularios</h5>
                <p class="card-text editable-text text-white">Acceso a encuestas y herramientas de recolección de datos.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="section-metas" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
          <h1 class="hero-title editable-text">Definición y Seguimiento de Metas</h1>
          <p class="hero-subtitle editable-text">
            Establezca metas SMART para la gestión de residuos. Monitoree la reducción y el reciclaje.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background-color: #ecf0f1;"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #16a085;">Meta de Reducción</h5>
                <p class="card-text editable-text">Establecer un objetivo del 15% de reducción de desechos municipales para el fin de año fiscal.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card" style="background-color: #2c3e50; color: white;"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Meta de Reciclaje</h5>
                <p class="card-text editable-text text-white">Aumentar la tasa de reciclaje de plásticos y papel al 40% en los próximos 6 meses.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-indicadores" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #34495e 0%, #5d6d7e 100%);">
          <h1 class="hero-title editable-text">Indicadores de Desempeño (KPIs)</h1>
          <p class="hero-subtitle editable-text">
            Visualice los datos en tiempo real sobre la generación, recolección y destino final de los residuos sólidos.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background-color: #f8c471;"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #34495e;">Tasa de Generación Per Cápita</h5>
                <p class="card-text editable-text">Cantidad promedio de residuos sólidos generados por persona al día (kg/hab/día).</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card" style="background-color: #d6eaf8;"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #34495e;">Composición de Residuos</h5>
                <p class="card-text editable-text">Porcentaje de residuos orgánicos, reciclables y rechazo en el total recolectado.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-avances" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%); color: #343a40;">
          <h1 class="hero-title editable-text" style="color: #343a40;">Monitor de Avances y Cumplimiento</h1>
          <p class="hero-subtitle editable-text" style="color: #343a40;">
            Seguimiento detallado de cada meta y acción implementada. Identifique cuellos de botella y éxitos.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background-color: #a9cce3;"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #f39c12;">Progreso de la Meta (Gráficos)</h5>
                <p class="card-text editable-text">Visualización de barras y líneas para comparar el objetivo vs. el avance actual.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card" style="background-color: #52be80; color: white;"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Tareas Pendientes y Logradas</h5>
                <p class="card-text editable-text text-white">Listado interactivo de acciones necesarias para alcanzar las metas.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-reportes" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
          <h1 class="hero-title editable-text">Generación de Documentos y Reportes</h1>
          <p class="hero-subtitle editable-text">
            Genere reportes anuales, trimestrales y de impacto ambiental en formato PDF o Excel.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background-color: #d5dbdb;"> 
              <div class="card-body">
                <h5 class="card-title editable-text" style="color: #2c3e50;">Reporte Anual de Sostenibilidad</h5>
                <p class="card-text editable-text">Resumen ejecutivo y datos consolidados de la gestión de residuos del año.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card" style="background-color: #bb8fce; color: white;"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">Reporte de Cumplimiento Normativo</h5>
                <p class="card-text editable-text text-white">Documento que valida el apego a las leyes y regulaciones ambientales locales.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-formularios" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <h1 class="hero-title editable-text">Encuestas y Recolección de Datos en Campo</h1>
          <p class="hero-subtitle editable-text">
            Acceda a los formularios externos utilizados para la medición y el análisis del comportamiento ciudadano.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card text-white" style="background-color: #2980b9;" data-card-link="https://tally.so/r/nGA7LO"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">ENCUESTA COMPORTAMIENTO PROAMBIENTAL</h5>
                <p class="card-text editable-text text-white">
                    Formulario para medir la actitud ciudadana hacia el reciclaje y la autosustentabilidad.
                </p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card text-white" style="background-color: #27ae60;" data-card-link="https://tally.so/r/3N1M0O"> 
              <div class="card-body">
                <h5 class="card-title editable-text text-white">MEDICIÓN DE DESECHOS SÓLIDOS (Daule)</h5>
                <p class="card-text editable-text text-white">
                    Encuesta técnica para la medición y caracterización de los desechos sólidos en la comunidad.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i> Acceso al Sistema</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="inputEmail" value="a@ug.com" required>
            </div>
            <div class="mb-3">
              <label for="inputPassword" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="inputPassword" value="1234" required>
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-success mt-3" onclick="handleLogin()">Ingresar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script>
    let isEditMode = false;
    let isLoggedIn = false; // NUEVA VARIABLE DE ESTADO
    let savedRange = null;
    let activeEditable = null;
    const MOVE_STEP = 1;
    const CONTENT_PADDING = 100;
    const RESTRICTED_SECTIONS = ['metas', 'avances', 'reportes']; // Secciones protegidas
    
    const MODERN_CARD_COLORS = [
        { bg: '#5D6D7E', text: 'white' },
        { bg: '#4CAF50', text: 'white' },
        { bg: '#3498DB', text: 'white' },
        { bg: '#F4D03F', text: '#343a40' },
        { bg: '#A93226', text: 'white' },
        { bg: '#9B59B6', text: 'white' },
        { bg: '#F5B041', text: '#343a40' },
        { bg: '#2ECC71', text: 'white' },
    ];

    // --- Lógica de Navegación (SPA) ---
    function showSection(sectionId) {
        // 1. VALIDACIÓN DE RESTRICCIÓN
        if (RESTRICTED_SECTIONS.includes(sectionId) && !isLoggedIn) {
            // Mostrar mensaje sutil sin alert
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 p-3 bg-warning text-dark rounded shadow';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Inicia sesión para acceder a esta sección</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Eliminar el mensaje después de 3 segundos
            setTimeout(() => {
                toast.remove();
            }, 3000);
            
            if (sectionId !== 'inicio') {
                 showSection('inicio'); // Redirige a inicio si el intento fue a otra página
            }
            return;
        }

        // 2. Muestra/Oculta secciones
        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
        });
        const sectionToShow = document.getElementById(`section-${sectionId}`);
        if (sectionToShow) {
            sectionToShow.style.display = 'block';
        }

        // 3. Limpiar la selección y actualizar estados
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false);
            else activeEditable.removeAttribute('contenteditable');
            activeEditable = null;
        }
        updatePositionInputs();
        // Espera un momento para asegurar que el contenido se cargue antes de medir la altura
        setTimeout(updateContentHeight, 50);
        
        // 4. Reinicializa Draggable/Resizable para la nueva sección
        initializeMovableElements();
    }
    
    function navigateToCardLink(link) {
        if (!link) return;

        if (link.startsWith('http')) {
            window.open(link, '_blank');
        } else if (link.startsWith('#')) {
            const sectionId = link.substring(1);
            showSection(sectionId); // Usa la función con la validación
        }
    }


    // --- Funciones de Mantenimiento de Altura ---
    function updateContentHeight() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        const movableElements = activeSection.querySelectorAll('.movable, .movable-card-wrapper');
        let maxBottom = 0;

        if (movableElements.length === 0) {
            const cardsRow = activeSection.querySelector('.cards-row');
            if (cardsRow) cardsRow.style.minHeight = '';
            document.getElementById('mainContent').style.minHeight = '';
            return; 
        }

        movableElements.forEach(el => {
            const top = parseFloat(el.style.top.replace('px', '')) || 0;
            const height = el.offsetHeight || 0; 
            maxBottom = Math.max(maxBottom, top + height);
        });

        const container = activeSection.querySelector('.cards-row') || document.getElementById('mainContent');
        const newMinHeight = maxBottom + CONTENT_PADDING;

        if (container) {
             container.style.minHeight = `${newMinHeight}px`;
        }
    }

    // --- Funciones de Formato, Posición y Elementos Movibles ---
    // (Funciones saveSelection, restoreSelection, formatText, addLink, changeStyle, 
    // updatePositionInputs, changePosition, changeSize, setMovableTextEditMode, 
    // makeElementDraggableAndResizable, addTextBox, addRandomColoredCard, deleteSelectedElement
    // Se mantienen igual a la versión anterior para no ser redundante, solo el entorno de ejecución cambia.)
    // ************************************************************************************************
    
    function saveSelection() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      if (activeEditable && activeEditable.getAttribute('contenteditable') === 'true' && activeEditable.contains(sel.focusNode)) {
        savedRange = sel.getRangeAt(0).cloneRange();
      }
    }
    function restoreSelection() {
      if (!savedRange) return;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
    }
    document.addEventListener('mouseup', saveSelection);
    document.addEventListener('keyup', saveSelection);

    function formatText(command) {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection(); 
            document.execCommand(command, false, null);
            saveSelection();
        }
    }
    
    function addLink() {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection();
            
            const url = prompt("Introduce la URL:", "http://");
            if (url && url !== "http://") document.execCommand("createLink", false, url);
            saveSelection();
        }
    }
    
    function changeStyle(property, value) {
        if (!activeEditable || !isEditMode) return;
        
        const targetElement = activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper');

        if (targetElement) {
             setMovableTextEditMode(targetElement, true);
        } else if (!activeEditable.hasAttribute('contenteditable')) {
            activeEditable.setAttribute('contenteditable', 'true');
        }
        
        activeEditable.focus();
        restoreSelection();

        const sel = window.getSelection();
        let rangeEmpty = !sel.rangeCount || sel.isCollapsed || sel.toString().trim() === '';

        if (property === 'hiliteColor') {
            if (!rangeEmpty) {
                document.execCommand('hiliteColor', false, value);
            } else if (activeEditable.closest('.card')) {
                activeEditable.closest('.card').style.backgroundColor = value;
            } else if (activeEditable.classList.contains('movable')) {
                activeEditable.style.backgroundColor = value;
            }
        } else if (property === 'color') {
            document.execCommand('foreColor', false, value);
        } else if (property === 'fontSize') {
            const size = parseInt(value, 10);
            if (isNaN(size) || size < 8 || size > 128) return;

            document.execCommand('fontSize', false, '7');
            const fonts = activeEditable.getElementsByTagName('font');
            for (let i = 0; i < fonts.length; i++) {
                if (fonts[i].size == '7') {
                    if (activeEditable.contains(fonts[i])) {
                        fonts[i].removeAttribute('size');
                        fonts[i].style.fontSize = `${size}px`;
                    }
                }
            }
        } else if (property === 'fontFamily') {
            document.execCommand('fontName', false, value);
        }

        saveSelection();
        activeEditable.focus();
    }
    
    function updatePositionInputs() {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const left = parseFloat(target.style.left.replace('px', '')) || 0;
            const top = parseFloat(target.style.top.replace('px', '')) || 0;
            const width = parseFloat(target.style.width.replace('px', '')) || target.offsetWidth;
            const height = parseFloat(target.style.height.replace('px', '')) || target.offsetHeight;

            document.getElementById('posLeftInput').value = Math.round(left);
            document.getElementById('posTopInput').value = Math.round(top);
            document.getElementById('widthInput').value = Math.round(width);
            document.getElementById('heightInput').value = Math.round(height);
        } else {
            document.getElementById('posLeftInput').value = '';
            document.getElementById('posTopInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('heightInput').value = '';
        }
    }

    function changePosition(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function changeSize(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function setMovableTextEditMode(el, enable) {
        if (!el || !$(el).data('ui-draggable')) return;

        if (enable) {
            if (activeEditable) activeEditable.setAttribute('contenteditable', 'true');
            $(el).draggable('disable');
            $(el).resizable('disable');
            el.classList.add('active-editable');

        } else {
            if (activeEditable) activeEditable.removeAttribute('contenteditable');
            $(el).draggable('enable');
            $(el).resizable('enable');
            el.classList.remove('active-editable'); 
        }
    }
    
    function makeElementDraggableAndResizable(el) {
        const container = document.querySelector('.section-content[style*="block"]');
        if (!container) return;

        $(el).draggable({
            containment: `#${container.id}`,
            scroll: false,
            start: function(event, ui) { 
                if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            drag: function(event, ui) { updateContentHeight(); },
            stop: function(event, ui) { updatePositionInputs(); updateContentHeight(); }
        });
        
        $(el).resizable({
            handles: 'all',
            minWidth: 100,
            minHeight: 50,
            disabled: el.closest('#section-inicio') || el.classList.contains('col'), 
            start: function(event, ui) {
                 if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            resize: function(event, ui) { updatePositionInputs(); updateContentHeight(); },
             stop: function(event, ui) { updateContentHeight(); }
        });
    }

    function initializeMovableElements() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        activeSection.querySelectorAll('.movable, .movable-card-wrapper').forEach(el => {
            if (isEditMode) makeElementDraggableAndResizable(el);
            else { 
                if ($(el).data('ui-draggable')) { $(el).draggable('destroy'); }
                if ($(el).data('ui-resizable')) { $(el).resizable('destroy'); }
            }
        });
    }

    function getActiveContentContainer() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        return activeSection || document.getElementById('section-inicio');
    }
    
    function addTextBox() {
        const container = getActiveContentContainer();
        const newBox = document.createElement("div");
        newBox.className = "editable-text movable text-box"; 
        newBox.setAttribute("contenteditable", "false"); 
        newBox.innerHTML = "<p>Doble clic para editar este texto...</p>"; 

        newBox.style.position = 'absolute';
        newBox.style.width = '200px'; 
        newBox.style.minHeight = '100px';
        
        const heroSection = container.querySelector('.hero-section');
        const staticContentBottom = heroSection ? heroSection.getBoundingClientRect().bottom - container.getBoundingClientRect().top + 50 : 200;
        
        newBox.style.left = '100px';
        newBox.style.top = `${staticContentBottom}px`; 
        newBox.style.backgroundColor = 'white'; 

        container.appendChild(newBox);
        
        if (isEditMode) {
            makeElementDraggableAndResizable(newBox);
            
            if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
                else activeEditable.removeAttribute('contenteditable');
            }
            activeEditable = newBox;
            updatePositionInputs();
            newBox.classList.add('active-editable');

            setMovableTextEditMode(newBox, true);
            newBox.focus();
            updateContentHeight();
        }
    }

    function addRandomColoredCard() {
        const activeSection = getActiveContentContainer();
        const cardsRow = activeSection.querySelector('.cards-row');
        if (!cardsRow) {
             alert("No se encontró el contenedor de tarjetas en esta sección. No se puede añadir.");
             return;
        }

        const colorIndex = Math.floor(Math.random() * MODERN_CARD_COLORS.length);
        const color = MODERN_CARD_COLORS[colorIndex];
        const isLight = color.text === '#343a40';

        const isHomeSection = activeSection.id === 'section-inicio';
        const colClass = isHomeSection ? 'col' : 'col-half movable-card-wrapper';
        
        const newCol = document.createElement('div');
        newCol.className = colClass;
        
        const newCard = document.createElement('div');
        newCard.className = isLight ? 'card h-100' : 'card text-white h-100';
        newCard.style.backgroundColor = color.bg;
        newCard.dataset.cardLink = '';

        if (!isHomeSection) {
            const movableElements = cardsRow.querySelectorAll('.movable-card-wrapper');
            let maxTop = 0;
            if (movableElements.length > 0) {
                 movableElements.forEach(el => {
                    const top = parseFloat(el.style.top.replace('px', '')) || 0;
                    const height = el.offsetHeight || 0;
                    maxTop = Math.max(maxTop, top + height);
                });
            } else {
                maxTop = 0;
            }
            newCol.style.position = 'absolute';
            newCol.style.top = `${maxTop + 20}px`; 
            newCol.style.left = '0px';
            newCol.style.width = '48%';
            newCol.style.minHeight = '150px';
        }
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title editable-text';
        cardTitle.textContent = "Nueva Tarjeta";
        cardTitle.style.color = color.text;

        const cardText = document.createElement('p');
        cardText.className = 'card-text editable-text';
        cardText.textContent = "Edite el título y la descripción.";
        cardText.style.color = color.text;

        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        newCard.appendChild(cardBody);
        newCol.appendChild(newCard);
        cardsRow.appendChild(newCol);
        
        if (isEditMode) {
             if (!isHomeSection) {
                 makeElementDraggableAndResizable(newCol);
             }

             if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
            }
             activeEditable = cardTitle; 
             newCard.classList.add('active-editable');
             cardTitle.classList.add('active-editable');
             cardText.classList.add('active-editable');
             updateContentHeight();
             updatePositionInputs();
        }
    }

    function deleteSelectedElement() {
      if (activeEditable) {
        if (confirm("¿Desea eliminar este elemento?")) {
          const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
          
          if (targetMovable) {
            if ($(targetMovable).data('ui-draggable')) { $(targetMovable).draggable('destroy'); }
            if ($(targetMovable).data('ui-resizable')) { $(targetMovable).resizable('destroy'); }
            targetMovable.remove();
          } 
          else if (activeEditable.closest('.card') && activeEditable.closest('#section-inicio')) {
              const cardCol = activeEditable.closest('.col');
              if (cardCol) {
                  cardCol.remove();
              }
          }
          else if (activeEditable.closest('.hero-section')) {
               activeEditable.innerHTML = "";
          }
          activeEditable = null;
          updatePositionInputs();
          updateContentHeight();
        }
      } else {
        alert("Seleccione primero un elemento para eliminar.");
      }
    }


    // --- Lógica de Clic y Selección ---
    let lastClickTime = 0;
    let clickCount = 0;

    document.addEventListener('click', function(e) {
      if (!isEditMode) {
          const card = e.target.closest('.card');
          if (card) {
               const link = card.dataset.cardLink;
               if (link) {
                   e.preventDefault();
                   e.stopPropagation();
                   navigateToCardLink(link);
               }
          }
          return;
      }
      
      const el = e.target.closest('.editable-text');
      const card = e.target.closest('.card'); 
      const cardWrapper = e.target.closest('.movable-card-wrapper');
      
      if (e.target.closest('#editSidebar')) return;

      const now = new Date().getTime();
      const timeDiff = now - lastClickTime;

      if (activeEditable) {
            const activeMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (activeMovable && activeMovable !== e.target.closest('.movable, .movable-card-wrapper')) {
                 setMovableTextEditMode(activeMovable, false);
            }
      }
      
      if (card && !el) {
          e.stopPropagation();
          e.preventDefault();
          
          const currentLink = card.dataset.cardLink || '';
          const newLink = prompt("Introduce la URL o la ID de sección (#metas) para esta tarjeta:", currentLink);
          
          if (newLink !== null) { 
              card.dataset.cardLink = newLink.trim();
              if (newLink.trim() === '') {
                   card.classList.remove('active-editable');
              } else {
                   card.classList.add('active-editable'); 
                   alert(`Enlace guardado: ${newLink}`);
              }
          }
          
          if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            activeEditable = null;
          }
          updatePositionInputs();
          return;
      }
      
      if (el && activeEditable === el) {
          if (timeDiff < 300) { clickCount++; } else { clickCount = 1; }
      } else { clickCount = 1; }
      lastClickTime = now;

      if (el && clickCount >= 3) {
          e.preventDefault();
          e.stopPropagation();
          const targetMovable = el.closest('.movable, .movable-card-wrapper');
          if (targetMovable) { 
              setMovableTextEditMode(targetMovable, true); 
          } else { 
              el.setAttribute('contenteditable', 'true'); 
          }
          el.focus();
          clickCount = 0;
          return;
      }

      if (el) {
        e.stopPropagation();

        if (activeEditable && activeEditable !== el) {
            activeEditable.classList.remove('active-editable');
        }
        
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });

        activeEditable = el;
        activeEditable.classList.add('active-editable');

        if (cardWrapper && cardWrapper.getAttribute('contenteditable') !== 'true') {
            setMovableTextEditMode(cardWrapper, false);
        }

        updatePositionInputs();
      } else if (!e.target.closest('.movable, .movable-card-wrapper')) {
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false); 
            activeEditable = null;
            updatePositionInputs();
        }
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });
      }
    });

    document.addEventListener('dblclick', function(e) {
        if (!isEditMode) return;
        const el = e.target.closest('.editable-text');
        if (el) {
            e.preventDefault();
            const targetMovable = el.closest('.movable, .movable-card-wrapper');
            if (targetMovable) { setMovableTextEditMode(targetMovable, true); } 
            else { el.setAttribute('contenteditable', 'true'); }
            el.focus();
        }
    });

    document.addEventListener('focusout', function(e) {
        if (!isEditMode) return;
        const el = e.target;

        if (el && el.classList.contains('editable-text') && el.getAttribute('contenteditable') === 'true') {
            setTimeout(() => {
                const newFocus = document.activeElement;
                const sidebar = document.getElementById('editSidebar');
                const isSelectingFont = newFocus && newFocus.id === 'fontFamilySelect'; 
                const targetMovable = el.closest('.movable, .movable-card-wrapper');

                if (!sidebar.contains(newFocus) || isSelectingFont) {
                    if (targetMovable) { setMovableTextEditMode(targetMovable, false); } 
                    else { el.removeAttribute('contenteditable'); }
                } else {
                    el.focus(); 
                    restoreSelection();
                }
            }, 100);
        }
    });


    // --- Lógica de Modo Edición y Login ---
    function unwrapCard(card) {
        const link = card.closest('.card-link');
        if (link && link.tagName === 'A') {
            const wrapper = link.closest('.col') || link.closest('.col-half') || link.closest('.movable-card-wrapper');
            if (wrapper) {
                 wrapper.insertBefore(card, link);
                 link.remove();
            }
        }
    }

    function wrapCardWithLink(card, url) {
        const wrapper = card.closest('.col') || card.closest('.col-half') || card.closest('.movable-card-wrapper');
        if (!wrapper) return;
        
        const existingLink = wrapper.querySelector('.card-link');
        if (existingLink) {
             existingLink.setAttribute('href', url);
        } else {
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('target', url.startsWith('#') ? '_self' : '_blank'); 
            link.className = 'card-link'; 
            
            wrapper.insertBefore(link, card);
            link.appendChild(card);
        }
    }


    function toggleEditMode() {
      if (!isLoggedIn) {
          alert("Debes iniciar sesión con una cuenta de Administrador para acceder al Modo Edición.");
          return;
      }
      isEditMode = !isEditMode;
      const allEditables = document.querySelectorAll('.editable-text');
      const cards = document.querySelectorAll('.card');
      const editButton = document.getElementById('editToggleBtn');
      const sidebar = document.getElementById('editSidebar');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      if (isEditMode) {
        // --- ACTIVAR EDICIÓN ---
        editButton.classList.replace('btn-outline-primary', 'btn-primary');
        editButton.innerHTML = '<i class="fas fa-save me-1"></i> Guardar Cambios';
        
        allEditables.forEach(el => el.classList.add('active-editable'));

        cards.forEach(card => {
             unwrapCard(card);
             if (card.dataset.cardLink && card.dataset.cardLink.trim() !== '') {
                 card.classList.add('active-editable');
             }
        });
        
        sidebar.classList.remove('d-none-temp');
        mainContentWrapper.style.marginLeft = '280px';
        
        initializeMovableElements();
        updateContentHeight();

      } else {
        // --- DESACTIVAR EDICIÓN ---
        editButton.classList.replace('btn-primary', 'btn-outline-primary');
        editButton.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición';
        
        allEditables.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('active-editable');
        });
        
        initializeMovableElements(); 

        cards.forEach(card => {
            card.classList.remove('active-editable');
            const link = card.dataset.cardLink;
            if (link && link.trim() !== '') {
                wrapCardWithLink(card, link);
            }
        });

        if (activeEditable) activeEditable.classList.remove('active-editable');
        activeEditable = null;
        savedRange = null; 
        updatePositionInputs();
        
        sidebar.classList.add('d-none-temp');
        mainContentWrapper.style.marginLeft = '0';
        document.getElementById('mainContent').style.minHeight = '';
      }
    }

    function handleLogin() {
      const emailInput = document.getElementById('inputEmail').value;
      const passwordInput = document.getElementById('inputPassword').value;
      if (emailInput === 'a@ug.com' && passwordInput === '1234') {
        isLoggedIn = true; // Establece el estado de inicio de sesión
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        document.getElementById('loginBtnContainer').classList.add('d-none');
        document.getElementById('userNav').classList.remove('d-none');
        document.getElementById('userNameDisplay').textContent = 'Administrador Daule';
        
        // Remover el bloqueo visual en la navegación
        document.querySelectorAll('.restricted-nav').forEach(el => {
            el.classList.remove('restricted-nav');
            el.querySelector('.fa-lock').classList.add('d-none');
        });
        
        // Remover la clase restricted de las tarjetas
        document.querySelectorAll('.card.restricted').forEach(card => {
            card.classList.remove('restricted');
        });

      } else {
          alert("Credenciales incorrectas. Inténtalo de nuevo.");
      }
    }
    function handleLogout() {
      if (isEditMode) toggleEditMode();
      isLoggedIn = false; // Restablece el estado de inicio de sesión
      document.getElementById('userNav').classList.add('d-none');
      document.getElementById('loginBtnContainer').classList.remove('d-none');

      // Restaurar el bloqueo visual en la navegación
      document.querySelectorAll('.navbar-nav .nav-item a').forEach(el => {
          const sectionId = el.getAttribute('onclick').match(/'(.*?)'/)[1];
          if (RESTRICTED_SECTIONS.includes(sectionId)) {
               el.classList.add('restricted-nav');
               el.querySelector('.fa-lock').classList.remove('d-none');
          }
      });
      
      // Restaurar la clase restricted a las tarjetas
      document.querySelectorAll('.card').forEach(card => {
          const link = card.dataset.cardLink;
          if (link && RESTRICTED_SECTIONS.includes(link.substring(1))) {
              card.classList.add('restricted');
          }
      });
      
      showSection('inicio');
    }

    // Inicializar el modo de movimiento por flechas
    document.addEventListener('keydown', function(e) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;
        if (!isEditMode || !target) return;
        
        if (activeEditable.getAttribute('contenteditable') === 'true' && document.activeElement === activeEditable) return; 

        let currentLeft = parseFloat(target.style.left.replace('px', '')) || 0;
        let currentTop = parseFloat(target.style.top.replace('px', '')) || 0;
        let moved = false;

        switch (e.key) {
            case 'ArrowUp': currentTop -= MOVE_STEP; moved = true; break;
            case 'ArrowDown': currentTop += MOVE_STEP; moved = true; break;
            case 'ArrowLeft': currentLeft -= MOVE_STEP; moved = true; break;
            case 'ArrowRight': currentLeft += MOVE_STEP; moved = true; break;
        }

        if (moved) {
            e.preventDefault();
            
            currentLeft = Math.max(0, currentLeft);
            currentTop = Math.max(0, currentTop);
            
            target.style.left = `${currentLeft}px`;
            target.style.top = `${currentTop}px`;
            
            updatePositionInputs();
            updateContentHeight();
        }
    });
    
    // Inicialización al cargar la página 
    document.addEventListener('DOMContentLoaded', () => {
        showSection('inicio'); 
    });

  </script>
</body>
</html>
