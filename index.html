<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Sistema de Gestión de Residuos Sólidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <style>
    /* Variables de diseño optimizadas para múltiples navegadores */
    :root {
      --primary-color: #1e7e34;
      --primary-dark: #166529;
      --secondary-color: #2c3e50;
      --accent-color: #3498db;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --border-radius: 12px;
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }
    
    /* Reset mejorado para compatibilidad entre navegadores */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Estilos Generales optimizados */
    body { 
      background-color: #f8f9fa; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      padding-top: constant(safe-area-inset-top);
      padding-top: env(safe-area-inset-top);
      padding-bottom: constant(safe-area-inset-bottom);
      padding-bottom: env(safe-area-inset-bottom);
      overflow-x: hidden;
    }
    
    /* Navbar mejorada con soporte para notch y áreas seguras */
    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 0.8rem 1rem;
      padding-top: calc(0.8rem + constant(safe-area-inset-top));
      padding-top: calc(0.8rem + env(safe-area-inset-top));
      padding-left: calc(1rem + constant(safe-area-inset-left));
      padding-left: calc(1rem + env(safe-area-inset-left));
      padding-right: calc(1rem + constant(safe-area-inset-right));
      padding-right: calc(1rem + env(safe-area-inset-right));
    }
    
    .navbar-brand-custom { 
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: 700;
      color: white !important;
      display: flex;
      align-items: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }
    
    .navbar-brand-custom i {
      font-size: clamp(1.5rem, 4vw, 1.8rem);
      margin-right: 10px;
    }
    
    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin: 0 2px;
      transition: var(--transition);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      white-space: nowrap;
    }
    
    .navbar-nav .nav-link:hover, 
    .navbar-nav .nav-link:focus {
      background-color: rgba(255, 255, 255, 0.15);
      color: white !important;
    }
    
    .nav-link.restricted-nav {
      color: rgba(255, 255, 255, 0.6) !important;
      cursor: pointer;
    }
    
    .nav-link.restricted-nav:hover {
      color: rgba(255, 255, 255, 0.8) !important; 
    }
    
    .navbar-toggler {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.25rem 0.5rem;
    }
    
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      width: 1.2em;
      height: 1.2em;
    }

    /* Panel Lateral mejorado con soporte táctil */
    #editSidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: min(300px, 85vw);
      padding-top: calc(70px + constant(safe-area-inset-top));
      padding-top: calc(70px + env(safe-area-inset-top));
      z-index: 1040;
      border-right: 1px solid #e9ecef;
      overflow-y: auto;
      background: white;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .sidebar-section { 
      padding: 15px 0; 
      border-bottom: 1px solid #e9ecef; 
    }
    
    .sidebar-section:last-child { 
      border-bottom: none; 
    }
    
    .sidebar-heading { 
      color: var(--secondary-color); 
      font-size: 0.95rem; 
      margin-bottom: 0.75rem; 
      display: flex; 
      align-items: center; 
      font-weight: 600;
    }
    
    .sidebar-heading i { 
      margin-right: 10px; 
      color: var(--primary-color);
    }

    /* Contenedor Principal optimizado */
    .d-none-temp { 
      display: none !important; 
    }
    
    .section-content { 
      display: none; 
      padding-top: 20px; 
      animation: fadeIn 0.5s ease;
    } 
    
    #section-inicio { 
      display: block; 
      padding-top: 0; 
    }
    
    #mainContentWrapper { 
      transition: margin-left .3s ease; 
      padding-left: constant(safe-area-inset-left);
      padding-left: env(safe-area-inset-left);
      padding-right: constant(safe-area-inset-right);
      padding-right: env(safe-area-inset-right);
    }
    
    #mainContent {
      position: relative;
      max-width: 1400px;
      padding-bottom: 50px; 
    }
    
    /* Hero Section optimizado para móviles */
    .hero-section {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #34495e 100%);
      color: white;
      padding: clamp(30px, 8vw, 60px) clamp(15px, 4vw, 30px);
      border-radius: var(--border-radius);
      margin-bottom: clamp(20px, 6vw, 40px);
      text-align: center;
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      margin-left: constant(safe-area-inset-left);
      margin-left: env(safe-area-inset-left);
      margin-right: constant(safe-area-inset-right);
      margin-right: env(safe-area-inset-right);
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
      background-size: cover;
    }
    
    .hero-title {
      font-size: clamp(1.8rem, 6vw, 2.8rem);
      font-weight: 800;
      margin-bottom: clamp(15px, 4vw, 20px);
      position: relative;
      line-height: 1.2;
    }
    
    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.3rem);
      max-width: min(900px, 90vw);
      margin: 0 auto;
      line-height: 1.7;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Cards optimizadas para touch */
    .card {
      height: 100%;
      transition: var(--transition);
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      cursor: pointer; 
      position: relative;
      overflow: hidden;
      background: white;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    /* Mejora para dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .card:hover {
        transform: none;
      }
      
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
    }
    
    .card-body {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: var(--dark-color) !important;
      padding: clamp(1.25rem, 4vw, 2rem);
      position: relative;
      z-index: 2;
    }
    
    .card-title { 
      font-weight: 700; 
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      margin-bottom: clamp(0.75rem, 2vw, 1rem);
      position: relative;
      line-height: 1.3;
    }
    
    .card-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }
    
    .card-text { 
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      opacity: 0.8; 
      line-height: 1.6;
    }
    
    .card-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: clamp(2rem, 5vw, 2.5rem);
      opacity: 0.1;
      z-index: 1;
    }

    /* Cards con fondo oscuro */
    .card.text-white .card-body { 
      color: white !important; 
    }
    
    .card.text-white .card-text { 
      opacity: 0.9; 
    }
    
    .card.text-white .card-title::after {
      background: white;
    }

    /* Estilo para tarjetas restringidas */
    .card.restricted {
      filter: grayscale(0.7) brightness(0.9);
      position: relative;
      overflow: hidden;
    }
    
    .card.restricted::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1;
    }
    
    .card.restricted .card-body {
      position: relative;
      z-index: 2;
    }
    
    .card.restricted .restricted-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 3;
      opacity: 0;
      transition: var(--transition);
      border-radius: var(--border-radius);
      padding: clamp(1rem, 3vw, 2rem);
      text-align: center;
    }
    
    .card.restricted:hover .restricted-overlay {
      opacity: 1;
    }
    
    /* Mejora para touch en overlay */
    @media (hover: none) and (pointer: coarse) {
      .card.restricted .restricted-overlay {
        opacity: 0.9;
      }
    }
    
    .card.restricted .restricted-overlay i {
      font-size: clamp(2rem, 6vw, 3rem);
      margin-bottom: clamp(10px, 3vw, 15px);
      color: var(--warning-color);
    }
    
    .card.restricted .restricted-overlay span {
      font-size: clamp(0.9rem, 3vw, 1.1rem);
      font-weight: 600;
    }

    /* Layout de Tarjetas en secciones internas */
    .section-content:not(#section-inicio) .cards-row {
      position: relative; 
      display: block; 
      min-height: 200px; 
      margin-top: 0;
    }
    
    .movable-card-wrapper {
      position: absolute; 
      width: 48%; 
      min-height: 150px;
      cursor: move !important;
      padding: 0;
    }
    
    .movable-card-wrapper .card {
      margin: 0 !important; 
      height: 100% !important;
      transform: none !important; 
    }

    /* Estilos de Edición optimizados para touch */
    .active-editable { 
      outline: 2px dashed var(--primary-color); 
    }

    /* Movable Text Box mejorado para dispositivos táctiles */
    .movable {
      position: absolute !important;
      z-index: 1000;
      border: none !important; 
      cursor: default !important;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      touch-action: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .movable.active-editable {
      border: 2px dashed var(--primary-color) !important;
      cursor: move !important;
    }
    
    .movable[contenteditable="true"] {
      cursor: text !important;
      outline: 2px dashed var(--success-color);
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    .text-box {
      padding: clamp(15px, 3vw, 20px);
      min-width: min(250px, 80vw);
      min-height: min(120px, 30vh);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      line-height: 1.6;
    }
    
    .text-box p { 
      margin: 0; 
    } 
    
    /* Cleanup para evitar saltos en texto estático */
    .editable-text:not([contenteditable="true"]):not(.movable) {
      border: 1px solid transparent !important; 
      padding: 5px;                           
      cursor: default;
    }
    
    .editable-text[contenteditable="true"]:not(.movable) {
      border: 1px dashed #ccc !important;
      padding: 5px; 
      cursor: text;
      outline: none !important; 
    }
    
    .hero-title.editable-text,
    .hero-subtitle.editable-text {
      padding: 5px !important;
      border: 1px solid transparent !important;
    }
    
    .hero-title.editable-text[contenteditable="true"],
    .hero-subtitle.editable-text[contenteditable="true"] {
      border: 1px dashed rgba(255, 255, 255, 0.5) !important;
      border-radius: 5px;
      padding: 5px !important;
    }
    
    /* Grid de tarjetas de inicio optimizado */
    .cards-row {
      --bs-gutter-x: clamp(1rem, 3vw, 1.5rem);
      --bs-gutter-y: clamp(1rem, 3vw, 1.5rem);
      display: flex;
      flex-wrap: wrap;
      position: relative;
    }
    
    .cards-row > .col {
      flex: 0 0 auto;
      width: 20%; 
      padding: calc(var(--bs-gutter-x) * .5);
      margin-top: var(--bs-gutter-y);
    }
    
    /* Botones mejorados con mejor área táctil */
    .btn-custom {
      border-radius: 8px;
      font-weight: 600;
      padding: clamp(0.5rem, 2vw, 0.6rem) clamp(1rem, 3vw, 1.2rem);
      transition: var(--transition);
      border: none;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      min-height: 44px; /* Tamaño mínimo para touch */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }
    
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(30, 126, 52, 0.3);
    }
    
    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      background: transparent;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    /* Mejora para botones en dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .btn-custom:hover {
        transform: none;
      }
      
      .btn-custom:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
    }
    
    /* Estilos para el modo edición optimizados */
    .edit-mode-indicator {
      position: fixed;
      top: clamp(70px, 12vw, 80px);
      right: clamp(10px, 3vw, 20px);
      background: linear-gradient(135deg, var(--warning-color), #e0a800);
      color: var(--dark-color);
      padding: clamp(6px, 2vw, 8px) clamp(12px, 3vw, 15px);
      border-radius: 30px;
      font-size: clamp(0.75rem, 2.5vw, 0.85rem);
      z-index: 1050;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-weight: 600;
      display: flex;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .edit-mode-indicator i {
      margin-right: 8px;
    }
    
    /* Estilos para el login modal optimizados */
    .login-modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-radius: 0;
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      margin: constant(safe-area-inset-top) constant(safe-area-inset-right) constant(safe-area-inset-bottom) constant(safe-area-inset-left);
      margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    /* Estilos para elementos de arrastre optimizados */
    .ui-draggable-dragging {
      z-index: 10000 !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
      transform: scale(1.02);
    }
    
    .ui-resizable-handle {
      background-color: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
      width: clamp(10px, 3vw, 12px) !important;
      height: clamp(10px, 3vw, 12px) !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Animaciones optimizadas */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease;
    }
    
    /* Responsive Design mejorado */
    @media (max-width: 1200px) {
      .cards-row > .col {
        width: 33.333%;
      }
    }
    
    @media (max-width: 992px) {
      #editSidebar {
        width: min(280px, 80vw);
      }
      
      .navbar-collapse {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-top: 1rem;
        box-shadow: var(--box-shadow);
      }
    }
    
    @media (max-width: 768px) {
      .cards-row > .col {
        width: 50%;
      }
      
      .movable-card-wrapper {
        width: 100%;
        position: relative !important;
        margin-bottom: 1rem;
      }
      
      .navbar-brand-custom {
        font-size: 1.3rem;
      }
      
      /* Mejoras específicas para móviles */
      .hero-title {
        font-size: clamp(1.5rem, 5vw, 2.2rem);
      }
      
      .hero-subtitle {
        font-size: clamp(0.9rem, 3vw, 1.1rem);
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .btn-custom {
        min-height: 48px;
        padding: 0.75rem 1rem;
      }
    }
    
    @media (max-width: 576px) {
      .cards-row > .col {
        width: 100%;
      }
      
      .card-body {
        padding: 1.25rem;
      }
      
      .edit-mode-indicator {
        top: 70px;
        right: 10px;
      }
      
      /* Mejoras específicas para móviles pequeños */
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
      
      .navbar-brand-custom {
        max-width: 60vw;
      }
      
      .hero-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
    }
    
    /* Soporte para orientación landscape en móviles */
    @media (max-height: 500px) and (orientation: landscape) {
      .navbar {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      
      .hero-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
      
      .hero-title {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .hero-subtitle {
        font-size: 0.9rem;
      }
      
      .card-body {
        padding: 0.75rem;
      }
    }
    
    /* Mejoras para tablets */
    @media (min-width: 768px) and (max-width: 1024px) {
      .cards-row > .col {
        width: 33.333%;
      }
      
      .hero-title {
        font-size: 2.2rem;
      }
      
      .hero-subtitle {
        font-size: 1.1rem;
      }
    }
    
    /* Soporte para navegadores WebKit (Safari) */
    @supports (-webkit-touch-callout: none) {
      .hero-section {
        -webkit-mask-image: -webkit-radial-gradient(white, black);
      }
      
      .card {
        -webkit-transform: translateZ(0);
      }
    }
    
    /* Mejoras para navegadores con soporte a scroll suave */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }
    
    /* Mejoras de accesibilidad */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Mejoras visuales adicionales */
    .section-title {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 700;
      margin-bottom: clamp(1rem, 3vw, 1.5rem);
      color: var(--secondary-color);
      position: relative;
      padding-bottom: 10px;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 4px;
      background: var(--primary-color);
      border-radius: 2px;
    }
    
    /* Mejoras para formularios en móviles */
    .form-control {
      font-size: 16px; /* Evita zoom automático en iOS */
    }
    
    /* Mejoras para elementos interactivos en móviles */
    .touch-target {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Mejoras para scroll en móviles */
    .mobile-scroll-container {
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    
    /* Mejoras para elementos de arrastre en móviles */
    .touch-draggable {
      touch-action: pan-x pan-y;
    }
  </style>
</head>
<body>
  <div id="editSidebar" class="bg-light d-none-temp p-3 shadow-sm" aria-hidden="true">
    <h5 class="text-primary mb-4"><i class="fas fa-tools"></i> Herramientas de Edición</h5>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-layer-group"></i> Elementos</h6>
        
        <button class="btn btn-sm btn-outline-success w-100 mb-2 touch-target" onclick="addRandomColoredCard()">
          <i class="fas fa-credit-card me-1"></i> Añadir Tarjeta
        </button>

        <button class="btn btn-sm btn-outline-primary w-100 mb-2 touch-target" onclick="addTextBox()">
          <i class="fas fa-square-plus me-1"></i> Agregar Cuadro de Texto
        </button>
        <button class="btn btn-sm btn-outline-danger w-100 mb-4 touch-target" onclick="deleteSelectedElement()">
          <i class="fas fa-trash me-1"></i> Eliminar Seleccionado
        </button>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-arrows-alt"></i> Posición y Tamaño</h6>
        <label class="form-label small fw-bold">Posición (px)</label>
        <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">X</span>
            <input type="number" id="posLeftInput" class="form-control" min="0" oninput="changePosition('left', this.value)">
            <span class="input-group-text">Y</span>
            <input type="number" id="posTopInput" class="form-control" min="0" oninput="changePosition('top', this.value)">
        </div>
        <label class="form-label small fw-bold">Dimensiones (px)</label>
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Ancho</span>
            <input type="number" id="widthInput" class="form-control" min="50" oninput="changeSize('width', this.value)">
            <span class="input-group-text">Alto</span>
            <input type="number" id="heightInput" class="form-control" min="30" oninput="changeSize('height', this.value)">
        </div>
        <div class="alert alert-info py-1 small">
          Mueve con <strong>flechas</strong> (↑↓←→) para precisión de 1px.
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-font"></i> Formato</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-dark touch-target" onclick="formatText('bold')" title="Negrita"><i class="fas fa-bold"></i></button>
          <button class="btn btn-sm btn-outline-dark touch-target" onclick="formatText('italic')" title="Cursiva"><i class="fas fa-italic"></i></button>
          <button class="btn btn-sm btn-outline-dark touch-target" onclick="formatText('underline')" title="Subrayado"><i class="fas fa-underline"></i></button>
          <button class="btn btn-sm btn-outline-primary touch-target" onclick="addLink()" title="Añadir enlace"><i class="fas fa-link"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-align-left"></i> Alineación</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('justifyLeft')"><i class="fas fa-align-left"></i></button>
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('justifyCenter')"><i class="fas fa-align-center"></i></button>
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('justifyRight')"><i class="fas fa-align-right"></i></button>
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('justifyFull')"><i class="fas fa-align-justify"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-list-ul"></i> Listas</h6>
        <div class="btn-group w-100 mb-4" role="group">
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('insertUnorderedList')" title="Viñetas"><i class="fas fa-list-ul"></i></button>
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('insertOrderedList')" title="Numeración"><i class="fas fa-list-ol"></i></button>
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-palette"></i> Estilos Visuales</h6>
        
        <label class="form-label small fw-bold">Tipo de Letra</label>
        <select class="form-select form-select-sm mb-3" id="fontFamilySelect" onchange="changeStyle('fontFamily', this.value)">
          <option value="Arial" style="font-family:Arial">Arial</option>
          <option value="Helvetica" style="font-family:Helvetica">Helvetica</option>
          <option value="Times New Roman" style="font-family:'Times New Roman'">Times New Roman</option>
          <option value="Courier New" style="font-family:'Courier New'">Courier New</option>
          <option value="Verdana" style="font-family:Verdana">Verdana</option>
          <option value="Georgia" style="font-family:Georgia">Georgia</option>
        </select>
        
        <label class="form-label small fw-bold">Tamaño de Fuente</label>
        <div class="input-group input-group-sm mb-3">
          <input type="number" id="fontSizeInput" class="form-control" min="8" max="128" placeholder="Ej: 16"
                 oninput="changeStyle('fontSize', this.value)"> 
          <span class="input-group-text">px</span>
        </div>

        <label class="form-label small fw-bold">Color de Texto</label>
        <input type="color" class="form-control form-control-sm mb-3"
               onchange="changeStyle('color', this.value)">

        <label class="form-label small fw-bold">Fondo</label>
        <input type="color" class="form-control form-control-sm mb-4"
               onchange="changeStyle('hiliteColor', this.value)"> 
    </div>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-history"></i> Historial</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('undo')" title="Deshacer"><i class="fas fa-undo"></i></button>
          <button class="btn btn-sm btn-outline-secondary touch-target" onclick="formatText('redo')" title="Rehacer"><i class="fas fa-redo"></i></button>
        </div>
    </div>

  </div>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand navbar-brand-custom" href="#" onclick="showSection('inicio')">
        <i class="fas fa-recycle"></i> Gestión de Residuos Sólidos
      </a>
      <button class="navbar-toggler touch-target" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link touch-target" href="#" onclick="showSection('inicio')">Inicio</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav touch-target" href="#" onclick="showSection('metas')">Metas <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link touch-target" href="#" onclick="showSection('indicadores')">Indicadores</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav touch-target" href="#" onclick="showSection('avances')">Avances <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link restricted-nav touch-target" href="#" onclick="showSection('reportes')">Reportes <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link touch-target" href="#" onclick="showSection('formularios')">Formularios</a></li>
        </ul>
        <ul class="navbar-nav" id="loginBtnContainer">
          <li class="nav-item">
            <button class="btn btn-outline-light btn-custom touch-target" type="button" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
            </button>
          </li>
        </ul>
        <ul class="navbar-nav d-none" id="userNav">
          <li class="nav-item">
            <button id="editToggleBtn" class="btn btn-outline-light btn-custom me-2 touch-target" onclick="toggleEditMode()">
              <i class="fas fa-edit me-1"></i> Modo Edición
            </button>
          </li>
          <li class="nav-item"><a class="nav-link touch-target" href="#"><i class="fas fa-bell"></i></a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle touch-target" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i> <span id="userNameDisplay">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item touch-target" href="#"><i class="fas fa-cog me-2"></i> Gestión de Usuarios</a></li>
              <li><a class="dropdown-item touch-target" href="#"><i class="fas fa-address-card me-2"></i> Mi Perfil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger touch-target" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="mainContentWrapper" class="container-fluid" style="margin-left:0;">
    <div class="container mt-4" id="mainContent">
      
      <div id="section-inicio" class="section-content">
        <div class="hero-section">
          <h1 class="hero-title editable-text" id="heroTitle">Sistema de Gestión de Residuos Sólidos</h1>
          <p class="hero-subtitle editable-text" id="heroSubtitle">
            Plataforma integral para monitorear indicadores, gestionar metas y generar reportes para una gestión ambiental eficiente y sostenible.
          </p>
        </div>

        <div class="cards-row mt-3"> 
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #5d6d7e, #34495e);" data-card-link="#metas"> 
              <div class="card-body">
                <i class="fas fa-bullseye card-icon"></i>
                <h5 class="card-title editable-text text-white">Metas</h5>
                <p class="card-text editable-text text-white">Definición de objetivos a corto y largo plazo para la reducción de residuos.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #4CAF50, #2E7D32);" data-card-link="#indicadores"> 
              <div class="card-body">
                <i class="fas fa-chart-line card-icon"></i>
                <h5 class="card-title editable-text text-white">Indicadores</h5>
                <p class="card-text editable-text text-white">Métricas clave para medir el éxito del plan de gestión.</p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card restricted" style="background: linear-gradient(135deg, #f4d03f, #f39c12); color: #343a40;" data-card-link="#avances"> 
              <div class="card-body">
                <i class="fas fa-tasks card-icon"></i>
                <h5 class="card-title editable-text" style="color: #343a40;">Avances</h5>
                <p class="card-text editable-text" style="color: #343a40;">Registro del progreso y cumplimiento de las metas establecidas.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #3498db, #2980b9);" data-card-link="#reportes"> 
              <div class="card-body">
                <i class="fas fa-file-alt card-icon"></i>
                <h5 class="card-title editable-text text-white">Reportes</h5>
                <p class="card-text editable-text text-white">Generación automática de informes de impacto y sostenibilidad.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" data-card-link="#formularios"> 
              <div class="card-body">
                <i class="fas fa-clipboard-list card-icon"></i>
                <h5 class="card-title editable-text text-white">Formularios</h5>
                <p class="card-text editable-text text-white">Acceso a encuestas y herramientas de recolección de datos.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Resto de las secciones con diseño mejorado -->
      <div id="section-metas" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
          <h1 class="hero-title editable-text">Definición y Seguimiento de Metas</h1>
          <p class="hero-subtitle editable-text">
            Establezca metas SMART para la gestión de residuos. Monitoree la reducción y el reciclaje.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background: linear-gradient(135deg, #ecf0f1, #d5dbdb);"> 
              <div class="card-body">
                <i class="fas fa-bullseye card-icon" style="color: #16a085;"></i>
                <h5 class="card-title editable-text" style="color: #16a085;">Meta de Reducción</h5>
                <p class="card-text editable-text">Establecer un objetivo del 15% de reducción de desechos municipales para el fin de año fiscal.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card text-white" style="background: linear-gradient(135deg, #2c3e50, #34495e);"> 
              <div class="card-body">
                <i class="fas fa-recycle card-icon"></i>
                <h5 class="card-title editable-text text-white">Meta de Reciclaje</h5>
                <p class="card-text editable-text text-white">Aumentar la tasa de reciclaje de plásticos y papel al 40% en los próximos 6 meses.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-indicadores" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #34495e 0%, #5d6d7e 100%);">
          <h1 class="hero-title editable-text">Indicadores de Desempeño (KPIs)</h1>
          <p class="hero-subtitle editable-text">
            Visualice los datos en tiempo real sobre la generación, recolección y destino final de los residuos sólidos.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background: linear-gradient(135deg, #f8c471, #f39c12);"> 
              <div class="card-body">
                <i class="fas fa-chart-bar card-icon" style="color: #34495e;"></i>
                <h5 class="card-title editable-text" style="color: #34495e;">Tasa de Generación Per Cápita</h5>
                <p class="card-text editable-text">Cantidad promedio de residuos sólidos generados por persona al día (kg/hab/día).</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card" style="background: linear-gradient(135deg, #d6eaf8, #aed6f1);"> 
              <div class="card-body">
                <i class="fas fa-pie-chart card-icon" style="color: #34495e;"></i>
                <h5 class="card-title editable-text" style="color: #34495e;">Composición de Residuos</h5>
                <p class="card-text editable-text">Porcentaje de residuos orgánicos, reciclables y rechazo en el total recolectado.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-avances" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%); color: #343a40;">
          <h1 class="hero-title editable-text" style="color: #343a40;">Monitor de Avances y Cumplimiento</h1>
          <p class="hero-subtitle editable-text" style="color: #343a40;">
            Seguimiento detallado de cada meta y acción implementada. Identifique cuellos de botella y éxitos.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background: linear-gradient(135deg, #a9cce3, #7fb3d5);"> 
              <div class="card-body">
                <i class="fas fa-chart-line card-icon" style="color: #f39c12;"></i>
                <h5 class="card-title editable-text" style="color: #f39c12;">Progreso de la Meta (Gráficos)</h5>
                <p class="card-text editable-text">Visualización de barras y líneas para comparar el objetivo vs. el avance actual.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card text-white" style="background: linear-gradient(135deg, #52be80, #27ae60);"> 
              <div class="card-body">
                <i class="fas fa-check-circle card-icon"></i>
                <h5 class="card-title editable-text text-white">Tareas Pendientes y Logradas</h5>
                <p class="card-text editable-text text-white">Listado interactivo de acciones necesarias para alcanzar las metas.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-reportes" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
          <h1 class="hero-title editable-text">Generación de Documentos y Reportes</h1>
          <p class="hero-subtitle editable-text">
            Genere reportes anuales, trimestrales y de impacto ambiental en formato PDF o Excel.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card" style="background: linear-gradient(135deg, #d5dbdb, #bdc3c7);"> 
              <div class="card-body">
                <i class="fas fa-file-pdf card-icon" style="color: #2c3e50;"></i>
                <h5 class="card-title editable-text" style="color: #2c3e50;">Reporte Anual de Sostenibilidad</h5>
                <p class="card-text editable-text">Resumen ejecutivo y datos consolidados de la gestión de residuos del año.</p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card text-white" style="background: linear-gradient(135deg, #bb8fce, #9b59b6);"> 
              <div class="card-body">
                <i class="fas fa-file-excel card-icon"></i>
                <h5 class="card-title editable-text text-white">Reporte de Cumplimiento Normativo</h5>
                <p class="card-text editable-text text-white">Documento que valida el apego a las leyes y regulaciones ambientales locales.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-formularios" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <h1 class="hero-title editable-text">Encuestas y Recolección de Datos en Campo</h1>
          <p class="hero-subtitle editable-text">
            Acceda a los formularios externos utilizados para la medición y el análisis del comportamiento ciudadano.
          </p>
        </div>
        <div class="cards-row mt-3">
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 0px; width: 48%;">
            <div class="card text-white" style="background: linear-gradient(135deg, #2980b9, #2471a3);" data-card-link="https://tally.so/r/nGA7LO"> 
              <div class="card-body">
                <i class="fas fa-clipboard-check card-icon"></i>
                <h5 class="card-title editable-text text-white">ENCUESTA COMPORTAMIENTO PROAMBIENTAL</h5>
                <p class="card-text editable-text text-white">
                    Formulario para medir la actitud ciudadana hacia el reciclaje y la autosustentabilidad.
                </p>
              </div>
            </div>
          </div>
          <div class="col-half movable-card-wrapper" style="top: 0px; left: 50%;">
            <div class="card text-white" style="background: linear-gradient(135deg, #27ae60, #229954);" data-card-link="https://tally.so/r/3N1M0O"> 
              <div class="card-body">
                <i class="fas fa-weight card-icon"></i>
                <h5 class="card-title editable-text text-white">MEDICIÓN DE DESECHOS SÓLIDOS (Daule)</h5>
                <p class="card-text editable-text text-white">
                    Encuesta técnica para la medición y caracterización de los desechos sólidos en la comunidad.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header login-modal-header text-white">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i> Acceso al Sistema</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="inputEmail" value="a@ug.com" required>
            </div>
            <div class="mb-3">
              <label for="inputPassword" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="inputPassword" value="1234" required>
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-success mt-3 btn-custom touch-target" onclick="handleLogin()">Ingresar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script>
    // El código JavaScript permanece igual pero con mejoras de rendimiento
    // para dispositivos móviles
    let isEditMode = false;
    let isLoggedIn = false;
    let savedRange = null;
    let activeEditable = null;
    const MOVE_STEP = 1;
    const CONTENT_PADDING = 100;
    const RESTRICTED_SECTIONS = ['metas', 'avances', 'reportes'];
    
    const MODERN_CARD_COLORS = [
        { bg: '#5D6D7E', text: 'white' },
        { bg: '#4CAF50', text: 'white' },
        { bg: '#3498DB', text: 'white' },
        { bg: '#F4D03F', text: '#343a40' },
        { bg: '#A93226', text: 'white' },
        { bg: '#9B59B6', text: 'white' },
        { bg: '#F5B041', text: '#343a40' },
        { bg: '#2ECC71', text: 'white' },
    ];

    // Detectar dispositivo táctil
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // --- Lógica de Navegación (SPA) ---
    function showSection(sectionId) {
        // Validación de restricción
        if (RESTRICTED_SECTIONS.includes(sectionId) && !isLoggedIn) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 p-3 bg-warning text-dark rounded shadow';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Inicia sesión para acceder a esta sección</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
            
            if (sectionId !== 'inicio') {
                 showSection('inicio');
            }
            return;
        }

        // Muestra/Oculta secciones
        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
        });
        const sectionToShow = document.getElementById(`section-${sectionId}`);
        if (sectionToShow) {
            sectionToShow.style.display = 'block';
        }

        // Limpiar la selección y actualizar estados
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false);
            else activeEditable.removeAttribute('contenteditable');
            activeEditable = null;
        }
        updatePositionInputs();
        
        // Espera un momento para asegurar que el contenido se cargue antes de medir la altura
        setTimeout(updateContentHeight, 50);
        
        // Reinicializa Draggable/Resizable para la nueva sección
        initializeMovableElements();
    }
    
    function navigateToCardLink(link) {
        if (!link) return;

        if (link.startsWith('http')) {
            window.open(link, '_blank');
        } else if (link.startsWith('#')) {
            const sectionId = link.substring(1);
            showSection(sectionId);
        }
    }

    // --- Funciones de Mantenimiento de Altura ---
    function updateContentHeight() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        // En la página de inicio, solo considerar elementos movibles (no las tarjetas)
        if (activeSection.id === 'section-inicio') {
            const movableElements = activeSection.querySelectorAll('.movable');
            let maxBottom = 0;

            if (movableElements.length === 0) {
                document.getElementById('mainContent').style.minHeight = '';
                return; 
            }

            movableElements.forEach(el => {
                const top = parseFloat(el.style.top.replace('px', '')) || 0;
                const height = el.offsetHeight || 0; 
                maxBottom = Math.max(maxBottom, top + height);
            });

            const newMinHeight = maxBottom + CONTENT_PADDING;
            document.getElementById('mainContent').style.minHeight = `${newMinHeight}px`;
        } else {
            // Para otras páginas, mantener la lógica original
            const movableElements = activeSection.querySelectorAll('.movable, .movable-card-wrapper');
            let maxBottom = 0;

            if (movableElements.length === 0) {
                const cardsRow = activeSection.querySelector('.cards-row');
                if (cardsRow) cardsRow.style.minHeight = '';
                document.getElementById('mainContent').style.minHeight = '';
                return; 
            }

            movableElements.forEach(el => {
                const top = parseFloat(el.style.top.replace('px', '')) || 0;
                const height = el.offsetHeight || 0; 
                maxBottom = Math.max(maxBottom, top + height);
            });

            const container = activeSection.querySelector('.cards-row') || document.getElementById('mainContent');
            const newMinHeight = maxBottom + CONTENT_PADDING;

            if (container) {
                 container.style.minHeight = `${newMinHeight}px`;
            }
        }
    }

    // --- Funciones de Formato, Posición y Elementos Movibles ---
    function saveSelection() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      if (activeEditable && activeEditable.getAttribute('contenteditable') === 'true' && activeEditable.contains(sel.focusNode)) {
        savedRange = sel.getRangeAt(0).cloneRange();
      }
    }
    
    function restoreSelection() {
      if (!savedRange) return;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
    }
    
    document.addEventListener('mouseup', saveSelection);
    document.addEventListener('keyup', saveSelection);

    function formatText(command) {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection(); 
            document.execCommand(command, false, null);
            saveSelection();
        }
    }
    
    function addLink() {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection();
            
            const url = prompt("Introduce la URL:", "http://");
            if (url && url !== "http://") document.execCommand("createLink", false, url);
            saveSelection();
        }
    }
    
    function changeStyle(property, value) {
        if (!activeEditable || !isEditMode) return;
        
        const targetElement = activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper');

        if (targetElement) {
             setMovableTextEditMode(targetElement, true);
        } else if (!activeEditable.hasAttribute('contenteditable')) {
            activeEditable.setAttribute('contenteditable', 'true');
        }
        
        activeEditable.focus();
        restoreSelection();

        const sel = window.getSelection();
        let rangeEmpty = !sel.rangeCount || sel.isCollapsed || sel.toString().trim() === '';

        if (property === 'hiliteColor') {
            if (!rangeEmpty) {
                document.execCommand('hiliteColor', false, value);
            } else if (activeEditable.closest('.card')) {
                activeEditable.closest('.card').style.backgroundColor = value;
            } else if (activeEditable.classList.contains('movable')) {
                activeEditable.style.backgroundColor = value;
            }
        } else if (property === 'color') {
            document.execCommand('foreColor', false, value);
        } else if (property === 'fontSize') {
            const size = parseInt(value, 10);
            if (isNaN(size) || size < 8 || size > 128) return;

            document.execCommand('fontSize', false, '7');
            const fonts = activeEditable.getElementsByTagName('font');
            for (let i = 0; i < fonts.length; i++) {
                if (fonts[i].size == '7') {
                    if (activeEditable.contains(fonts[i])) {
                        fonts[i].removeAttribute('size');
                        fonts[i].style.fontSize = `${size}px`;
                    }
                }
            }
        } else if (property === 'fontFamily') {
            document.execCommand('fontName', false, value);
        }

        saveSelection();
        activeEditable.focus();
    }
    
    function updatePositionInputs() {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const left = parseFloat(target.style.left.replace('px', '')) || 0;
            const top = parseFloat(target.style.top.replace('px', '')) || 0;
            const width = parseFloat(target.style.width.replace('px', '')) || target.offsetWidth;
            const height = parseFloat(target.style.height.replace('px', '')) || target.offsetHeight;

            document.getElementById('posLeftInput').value = Math.round(left);
            document.getElementById('posTopInput').value = Math.round(top);
            document.getElementById('widthInput').value = Math.round(width);
            document.getElementById('heightInput').value = Math.round(height);
        } else {
            document.getElementById('posLeftInput').value = '';
            document.getElementById('posTopInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('heightInput').value = '';
        }
    }

    function changePosition(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function changeSize(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function setMovableTextEditMode(el, enable) {
        if (!el || !$(el).data('ui-draggable')) return;

        if (enable) {
            if (activeEditable) activeEditable.setAttribute('contenteditable', 'true');
            $(el).draggable('disable');
            $(el).resizable('disable');
            el.classList.add('active-editable');

        } else {
            if (activeEditable) activeEditable.removeAttribute('contenteditable');
            $(el).draggable('enable');
            $(el).resizable('enable');
            el.classList.remove('active-editable'); 
        }
    }
    
    function makeElementDraggableAndResizable(el) {
        const container = document.querySelector('.section-content[style*="block"]');
        if (!container) return;

        // Configuración optimizada para dispositivos táctiles
        const dragOptions = {
            containment: `#${container.id}`,
            scroll: false,
            start: function(event, ui) { 
                if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            drag: function(event, ui) { updateContentHeight(); },
            stop: function(event, ui) { updatePositionInputs(); updateContentHeight(); }
        };

        // Mejoras para dispositivos táctiles
        if (isTouchDevice) {
            dragOptions.delay = 200;
            dragOptions.distance = 10;
        }

        $(el).draggable(dragOptions);
        
        $(el).resizable({
            handles: 'all',
            minWidth: 100,
            minHeight: 50,
            disabled: el.closest('#section-inicio') || el.classList.contains('col'), 
            start: function(event, ui) {
                 if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            resize: function(event, ui) { updatePositionInputs(); updateContentHeight(); },
             stop: function(event, ui) { updateContentHeight(); }
        });
    }

    function initializeMovableElements() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        activeSection.querySelectorAll('.movable, .movable-card-wrapper').forEach(el => {
            if (isEditMode) makeElementDraggableAndResizable(el);
            else { 
                if ($(el).data('ui-draggable')) { $(el).draggable('destroy'); }
                if ($(el).data('ui-resizable')) { $(el).resizable('destroy'); }
            }
        });
    }

    function getActiveContentContainer() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        return activeSection || document.getElementById('section-inicio');
    }
    
    function addTextBox() {
        const container = getActiveContentContainer();
        const newBox = document.createElement("div");
        newBox.className = "editable-text movable text-box"; 
        newBox.setAttribute("contenteditable", "false"); 
        newBox.innerHTML = "<p>Doble clic para editar este texto...</p>"; 

        newBox.style.position = 'absolute';
        newBox.style.width = '200px'; 
        newBox.style.minHeight = '100px';
        
        const heroSection = container.querySelector('.hero-section');
        const staticContentBottom = heroSection ? heroSection.getBoundingClientRect().bottom - container.getBoundingClientRect().top + 50 : 200;
        
        newBox.style.left = '100px';
        newBox.style.top = `${staticContentBottom}px`; 
        newBox.style.backgroundColor = 'white'; 

        container.appendChild(newBox);
        
        if (isEditMode) {
            makeElementDraggableAndResizable(newBox);
            
            if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
                else activeEditable.removeAttribute('contenteditable');
            }
            activeEditable = newBox;
            updatePositionInputs();
            newBox.classList.add('active-editable');

            setMovableTextEditMode(newBox, true);
            newBox.focus();
            updateContentHeight();
        }
    }

    function addRandomColoredCard() {
        const activeSection = getActiveContentContainer();
        const cardsRow = activeSection.querySelector('.cards-row');
        if (!cardsRow) {
             alert("No se encontró el contenedor de tarjetas en esta sección. No se puede añadir.");
             return;
        }

        const colorIndex = Math.floor(Math.random() * MODERN_CARD_COLORS.length);
        const color = MODERN_CARD_COLORS[colorIndex];
        const isLight = color.text === '#343a40';

        const isHomeSection = activeSection.id === 'section-inicio';
        const colClass = isHomeSection ? 'col' : 'col-half movable-card-wrapper';
        
        const newCol = document.createElement('div');
        newCol.className = colClass;
        
        const newCard = document.createElement('div');
        newCard.className = isLight ? 'card h-100' : 'card text-white h-100';
        newCard.style.backgroundColor = color.bg;
        newCard.dataset.cardLink = '';

        if (!isHomeSection) {
            const movableElements = cardsRow.querySelectorAll('.movable-card-wrapper');
            let maxTop = 0;
            if (movableElements.length > 0) {
                 movableElements.forEach(el => {
                    const top = parseFloat(el.style.top.replace('px', '')) || 0;
                    const height = el.offsetHeight || 0;
                    maxTop = Math.max(maxTop, top + height);
                });
            } else {
                maxTop = 0;
            }
            newCol.style.position = 'absolute';
            newCol.style.top = `${maxTop + 20}px`; 
            newCol.style.left = '0px';
            newCol.style.width = '48%';
            newCol.style.minHeight = '150px';
        }
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title editable-text';
        cardTitle.textContent = "Nueva Tarjeta";
        cardTitle.style.color = color.text;

        const cardText = document.createElement('p');
        cardText.className = 'card-text editable-text';
        cardText.textContent = "Edite el título y la descripción.";
        cardText.style.color = color.text;

        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        newCard.appendChild(cardBody);
        newCol.appendChild(newCard);
        cardsRow.appendChild(newCol);
        
        if (isEditMode) {
             if (!isHomeSection) {
                 makeElementDraggableAndResizable(newCol);
             }

             if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
            }
             activeEditable = cardTitle; 
             newCard.classList.add('active-editable');
             cardTitle.classList.add('active-editable');
             cardText.classList.add('active-editable');
             updateContentHeight();
             updatePositionInputs();
        }
    }

    function deleteSelectedElement() {
      if (activeEditable) {
        if (confirm("¿Desea eliminar este elemento?")) {
          const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
          
          if (targetMovable) {
            if ($(targetMovable).data('ui-draggable')) { $(targetMovable).draggable('destroy'); }
            if ($(targetMovable).data('ui-resizable')) { $(targetMovable).resizable('destroy'); }
            targetMovable.remove();
          } 
          else if (activeEditable.closest('.card') && activeEditable.closest('#section-inicio')) {
              const cardCol = activeEditable.closest('.col');
              if (cardCol) {
                  cardCol.remove();
              }
          }
          else if (activeEditable.closest('.hero-section')) {
               activeEditable.innerHTML = "";
          }
          activeEditable = null;
          updatePositionInputs();
          updateContentHeight();
        }
      } else {
        alert("Seleccione primero un elemento para eliminar.");
      }
    }

    // --- Lógica de Clic y Selección optimizada para touch ---
    let lastClickTime = 0;
    let clickCount = 0;

    document.addEventListener('click', function(e) {
      if (!isEditMode) {
          const card = e.target.closest('.card');
          if (card) {
               const link = card.dataset.cardLink;
               if (link) {
                   e.preventDefault();
                   e.stopPropagation();
                   navigateToCardLink(link);
               }
          }
          return;
      }
      
      const el = e.target.closest('.editable-text');
      const card = e.target.closest('.card'); 
      const cardWrapper = e.target.closest('.movable-card-wrapper');
      
      if (e.target.closest('#editSidebar')) return;

      const now = new Date().getTime();
      const timeDiff = now - lastClickTime;

      if (activeEditable) {
            const activeMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (activeMovable && activeMovable !== e.target.closest('.movable, .movable-card-wrapper')) {
                 setMovableTextEditMode(activeMovable, false);
            }
      }
      
      if (card && !el) {
          e.stopPropagation();
          e.preventDefault();
          
          const currentLink = card.dataset.cardLink || '';
          const newLink = prompt("Introduce la URL o la ID de sección (#metas) para esta tarjeta:", currentLink);
          
          if (newLink !== null) { 
              card.dataset.cardLink = newLink.trim();
              if (newLink.trim() === '') {
                   card.classList.remove('active-editable');
              } else {
                   card.classList.add('active-editable'); 
                   alert(`Enlace guardado: ${newLink}`);
              }
          }
          
          if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            activeEditable = null;
          }
          updatePositionInputs();
          return;
      }
      
      if (el && activeEditable === el) {
          if (timeDiff < 300) { clickCount++; } else { clickCount = 1; }
      } else { clickCount = 1; }
      lastClickTime = now;

      if (el && clickCount >= 3) {
          e.preventDefault();
          e.stopPropagation();
          const targetMovable = el.closest('.movable, .movable-card-wrapper');
          if (targetMovable) { 
              setMovableTextEditMode(targetMovable, true); 
          } else { 
              el.setAttribute('contenteditable', 'true'); 
          }
          el.focus();
          clickCount = 0;
          return;
      }

      if (el) {
        e.stopPropagation();

        if (activeEditable && activeEditable !== el) {
            activeEditable.classList.remove('active-editable');
        }
        
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });

        activeEditable = el;
        activeEditable.classList.add('active-editable');

        if (cardWrapper && cardWrapper.getAttribute('contenteditable') !== 'true') {
            setMovableTextEditMode(cardWrapper, false);
        }

        updatePositionInputs();
      } else if (!e.target.closest('.movable, .movable-card-wrapper')) {
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false); 
            activeEditable = null;
            updatePositionInputs();
        }
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });
      }
    });

    document.addEventListener('dblclick', function(e) {
        if (!isEditMode) return;
        const el = e.target.closest('.editable-text');
        if (el) {
            e.preventDefault();
            const targetMovable = el.closest('.movable, .movable-card-wrapper');
            if (targetMovable) { setMovableTextEditMode(targetMovable, true); } 
            else { el.setAttribute('contenteditable', 'true'); }
            el.focus();
        }
    });

    document.addEventListener('focusout', function(e) {
        if (!isEditMode) return;
        const el = e.target;

        if (el && el.classList.contains('editable-text') && el.getAttribute('contenteditable') === 'true') {
            setTimeout(() => {
                const newFocus = document.activeElement;
                const sidebar = document.getElementById('editSidebar');
                const isSelectingFont = newFocus && newFocus.id === 'fontFamilySelect'; 
                const targetMovable = el.closest('.movable, .movable-card-wrapper');

                if (!sidebar.contains(newFocus) || isSelectingFont) {
                    if (targetMovable) { setMovableTextEditMode(targetMovable, false); } 
                    else { el.removeAttribute('contenteditable'); }
                } else {
                    el.focus(); 
                    restoreSelection();
                }
            }, 100);
        }
    });

    // --- Lógica de Modo Edición y Login ---
    function unwrapCard(card) {
        const link = card.closest('.card-link');
        if (link && link.tagName === 'A') {
            const wrapper = link.closest('.col') || link.closest('.col-half') || link.closest('.movable-card-wrapper');
            if (wrapper) {
                 wrapper.insertBefore(card, link);
                 link.remove();
            }
        }
    }

    function wrapCardWithLink(card, url) {
        const wrapper = card.closest('.col') || card.closest('.col-half') || card.closest('.movable-card-wrapper');
        if (!wrapper) return;
        
        const existingLink = wrapper.querySelector('.card-link');
        if (existingLink) {
             existingLink.setAttribute('href', url);
        } else {
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('target', url.startsWith('#') ? '_self' : '_blank'); 
            link.className = 'card-link'; 
            
            wrapper.insertBefore(link, card);
            link.appendChild(card);
        }
    }

    function toggleEditMode() {
      if (!isLoggedIn) {
          alert("Debes iniciar sesión con una cuenta de Administrador para acceder al Modo Edición.");
          return;
      }
      isEditMode = !isEditMode;
      const allEditables = document.querySelectorAll('.editable-text');
      const cards = document.querySelectorAll('.card');
      const editButton = document.getElementById('editToggleBtn');
      const sidebar = document.getElementById('editSidebar');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      if (isEditMode) {
        // --- ACTIVAR EDICIÓN ---
        editButton.classList.replace('btn-outline-light', 'btn-light');
        editButton.innerHTML = '<i class="fas fa-save me-1"></i> Guardar Cambios';
        
        // Mostrar indicador de modo edición
        const editIndicator = document.createElement('div');
        editIndicator.className = 'edit-mode-indicator';
        editIndicator.id = 'editModeIndicator';
        editIndicator.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición Activo';
        document.body.appendChild(editIndicator);
        
        allEditables.forEach(el => el.classList.add('active-editable'));

        cards.forEach(card => {
             unwrapCard(card);
             if (card.dataset.cardLink && card.dataset.cardLink.trim() !== '') {
                 card.classList.add('active-editable');
             }
        });
        
        sidebar.classList.remove('d-none-temp');
        mainContentWrapper.style.marginLeft = 'min(300px, 85vw)';
        
        initializeMovableElements();
        updateContentHeight();

      } else {
        // --- DESACTIVAR EDICIÓN ---
        editButton.classList.replace('btn-light', 'btn-outline-light');
        editButton.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición';
        
        // Eliminar indicador de modo edición
        const editIndicator = document.getElementById('editModeIndicator');
        if (editIndicator) editIndicator.remove();
        
        allEditables.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('active-editable');
        });
        
        initializeMovableElements(); 

        cards.forEach(card => {
            card.classList.remove('active-editable');
            const link = card.dataset.cardLink;
            if (link && link.trim() !== '') {
                wrapCardWithLink(card, link);
            }
        });

        if (activeEditable) activeEditable.classList.remove('active-editable');
        activeEditable = null;
        savedRange = null; 
        updatePositionInputs();
        
        sidebar.classList.add('d-none-temp');
        mainContentWrapper.style.marginLeft = '0';
        document.getElementById('mainContent').style.minHeight = '';
      }
    }

    function handleLogin() {
      const emailInput = document.getElementById('inputEmail').value;
      const passwordInput = document.getElementById('inputPassword').value;
      if (emailInput === 'a@ug.com' && passwordInput === '1234') {
        isLoggedIn = true;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        document.getElementById('loginBtnContainer').classList.add('d-none');
        document.getElementById('userNav').classList.remove('d-none');
        document.getElementById('userNameDisplay').textContent = 'Administrador Daule';
        
        // Remover el bloqueo visual en la navegación
        document.querySelectorAll('.restricted-nav').forEach(el => {
            el.classList.remove('restricted-nav');
            el.querySelector('.fa-lock').classList.add('d-none');
        });
        
        // Remover la clase restricted de las tarjetas
        document.querySelectorAll('.card.restricted').forEach(card => {
            card.classList.remove('restricted');
        });

      } else {
          alert("Credenciales incorrectas. Inténtalo de nuevo.");
      }
    }
    
    function handleLogout() {
      if (isEditMode) toggleEditMode();
      isLoggedIn = false;
      document.getElementById('userNav').classList.add('d-none');
      document.getElementById('loginBtnContainer').classList.remove('d-none');

      // Restaurar el bloqueo visual en la navegación
      document.querySelectorAll('.navbar-nav .nav-item a').forEach(el => {
          const sectionId = el.getAttribute('onclick').match(/'(.*?)'/)[1];
          if (RESTRICTED_SECTIONS.includes(sectionId)) {
               el.classList.add('restricted-nav');
               el.querySelector('.fa-lock').classList.remove('d-none');
          }
      });
      
      // Restaurar la clase restricted a las tarjetas
      document.querySelectorAll('.card').forEach(card => {
          const link = card.dataset.cardLink;
          if (link && RESTRICTED_SECTIONS.includes(link.substring(1))) {
              card.classList.add('restricted');
          }
      });
      
      showSection('inicio');
    }

    // Inicializar el modo de movimiento por flechas
    document.addEventListener('keydown', function(e) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;
        if (!isEditMode || !target) return;
        
        if (activeEditable.getAttribute('contenteditable') === 'true' && document.activeElement === activeEditable) return; 

        let currentLeft = parseFloat(target.style.left.replace('px', '')) || 0;
        let currentTop = parseFloat(target.style.top.replace('px', '')) || 0;
        let moved = false;

        switch (e.key) {
            case 'ArrowUp': currentTop -= MOVE_STEP; moved = true; break;
            case 'ArrowDown': currentTop += MOVE_STEP; moved = true; break;
            case 'ArrowLeft': currentLeft -= MOVE_STEP; moved = true; break;
            case 'ArrowRight': currentLeft += MOVE_STEP; moved = true; break;
        }

        if (moved) {
            e.preventDefault();
            
            currentLeft = Math.max(0, currentLeft);
            currentTop = Math.max(0, currentTop);
            
            target.style.left = `${currentLeft}px`;
            target.style.top = `${currentTop}px`;
            
            updatePositionInputs();
            updateContentHeight();
        }
    });
    
    // Inicialización al cargar la página 
    document.addEventListener('DOMContentLoaded', () => {
        showSection('inicio'); 
        
        // Mejora de rendimiento para dispositivos móviles
        if (isTouchDevice) {
            // Optimizar para rendimiento en dispositivos táctiles
            document.body.classList.add('touch-device');
        }
    });

  </script>
</body>
</html>
