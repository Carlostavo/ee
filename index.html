<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Sistema de Gestión de Residuos Sólidos - Cantón Daule</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Variables de diseño profesionales y suaves */
    :root {
      --primary-color: #2E8B57;
      --primary-light: #3CB371;
      --primary-dark: #228B22;
      --secondary-color: #4A6FA5;
      --secondary-light: #6B8CBE;
      --accent-color: #FF7E5F;
      --light-color: #F8F9FA;
      --light-gray: #E9ECEF;
      --medium-gray: #CED4DA;
      --dark-gray: #6C757D;
      --dark-color: #343A40;
      --success-color: #28A745;
      --warning-color: #FFC107;
      --danger-color: #DC3545;
      --info-color: #17A2B8;
      --border-radius: 12px;
      --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }
    
    /* Reset mejorado */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Estilos Generales optimizados */
    body { 
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', system-ui, -apple-system, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #495057;
      padding-top: constant(safe-area-inset-top);
      padding-top: env(safe-area-inset-top);
      padding-bottom: constant(safe-area-inset-bottom);
      padding-bottom: env(safe-area-inset-bottom);
      margin: 0;
      padding: 0;
    }
    
    /* Navbar mejorada con colores suaves */
    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 0.8rem 1rem;
      padding-top: calc(0.8rem + constant(safe-area-inset-top));
      padding-top: calc(0.8rem + env(safe-area-inset-top));
      padding-left: calc(1rem + constant(safe-area-inset-left));
      padding-left: calc(1rem + env(safe-area-inset-left));
      padding-right: calc(1rem + constant(safe-area-inset-right));
      padding-right: calc(1rem + env(safe-area-inset-right));
    }
    
    .navbar-brand-custom { 
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: 700;
      color: white !important;
      display: flex;
      align-items: center;
    }
    
    .navbar-brand-custom i {
      font-size: clamp(1.5rem, 4vw, 1.8rem);
      margin-right: 10px;
    }
    
    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin: 0 2px;
      transition: var(--transition);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
    }
    
    .navbar-nav .nav-link:hover, 
    .navbar-nav .nav-link:focus {
      background-color: rgba(255, 255, 255, 0.15);
      color: white !important;
    }
    
    .nav-link.restricted-nav {
      color: rgba(255, 255, 255, 0.6) !important;
      cursor: pointer;
    }
    
    .nav-link.restricted-nav:hover {
      color: rgba(255, 255, 255, 0.8) !important; 
    }
    
    .navbar-toggler {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.25rem 0.5rem;
    }
    
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      width: 1.2em;
      height: 1.2em;
    }

    /* Panel Lateral mejorado */
    #editSidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: min(300px, 85vw);
      padding-top: calc(70px + constant(safe-area-inset-top));
      padding-top: calc(70px + env(safe-area-inset-top));
      z-index: 1040;
      border-right: 1px solid var(--light-gray);
      overflow-y: auto;
      background: white;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      box-shadow: var(--box-shadow-light);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .sidebar-section { 
      padding: 15px 0; 
      border-bottom: 1px solid var(--light-gray); 
    }
    
    .sidebar-section:last-child { 
      border-bottom: none; 
    }
    
    .sidebar-heading { 
      color: var(--secondary-color); 
      font-size: 0.95rem; 
      margin-bottom: 0.75rem; 
      display: flex; 
      align-items: center; 
      font-weight: 600;
    }
    
    .sidebar-heading i { 
      margin-right: 10px; 
      color: var(--primary-color);
    }

    /* Contenedor Principal optimizado */
    .d-none-temp { 
      display: none !important; 
    }
    
    .section-content { 
      display: none; 
      padding-top: 20px; 
      animation: fadeIn 0.5s ease;
      position: relative;
      min-height: 100px;
    } 
    
    #section-inicio { 
      display: block; 
      padding-top: 0; 
    }
    
    #mainContentWrapper { 
      transition: margin-left .3s ease; 
      padding-left: constant(safe-area-inset-left);
      padding-left: env(safe-area-inset-left);
      padding-right: constant(safe-area-inset-right);
      padding-right: env(safe-area-inset-right);
    }
    
    #mainContent {
      position: relative;
      max-width: 1400px;
      padding-bottom: 20px;
      min-height: auto;
    }
    
    /* Hero Section optimizado */
    .hero-section {
      background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-light) 100%);
      color: white;
      padding: clamp(30px, 8vw, 60px) clamp(15px, 4vw, 30px);
      border-radius: var(--border-radius);
      margin-bottom: clamp(20px, 6vw, 40px);
      text-align: center;
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      margin-left: constant(safe-area-inset-left);
      margin-left: env(safe-area-inset-left);
      margin-right: constant(safe-area-inset-right);
      margin-right: env(safe-area-inset-right);
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
      background-size: cover;
    }
    
    .hero-title {
      font-size: clamp(1.8rem, 6vw, 2.8rem);
      font-weight: 700;
      margin-bottom: clamp(15px, 4vw, 20px);
      position: relative;
      line-height: 1.2;
    }
    
    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.3rem);
      max-width: min(900px, 90vw);
      margin: 0 auto;
      line-height: 1.7;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Cards optimizadas con colores suaves */
    .card {
      height: 100%;
      transition: var(--transition);
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-light);
      cursor: pointer; 
      position: relative;
      overflow: hidden;
      background: white;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.1);
    }
    
    /* Mejora para dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .card:hover {
        transform: none;
      }
      
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
    }
    
    .card-body {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: var(--dark-color) !important;
      padding: clamp(1.25rem, 4vw, 2rem);
      position: relative;
      z-index: 2;
    }
    
    .card-title { 
      font-weight: 600; 
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      margin-bottom: clamp(0.75rem, 2vw, 1rem);
      position: relative;
      line-height: 1.3;
    }
    
    .card-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }
    
    .card-text { 
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      opacity: 0.8; 
      line-height: 1.6;
    }
    
    .card-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: clamp(2rem, 5vw, 2.5rem);
      opacity: 0.1;
      z-index: 1;
    }

    /* Cards con fondo oscuro */
    .card.text-white .card-body { 
      color: white !important; 
    }
    
    .card.text-white .card-text { 
      opacity: 0.9; 
    }
    
    .card.text-white .card-title::after {
      background: white;
    }

    /* Estilo para tarjetas restringidas */
    .card.restricted {
      filter: grayscale(0.7) brightness(0.9);
      position: relative;
      overflow: hidden;
    }
    
    .card.restricted::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1;
    }
    
    .card.restricted .card-body {
      position: relative;
      z-index: 2;
    }
    
    .card.restricted .restricted-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 3;
      opacity: 0;
      transition: var(--transition);
      border-radius: var(--border-radius);
      padding: clamp(1rem, 3vw, 2rem);
      text-align: center;
    }
    
    .card.restricted:hover .restricted-overlay {
      opacity: 1;
    }
    
    /* Mejora para touch en overlay */
    @media (hover: none) and (pointer: coarse) {
      .card.restricted .restricted-overlay {
        opacity: 0.9;
      }
    }
    
    .card.restricted .restricted-overlay i {
      font-size: clamp(2rem, 6vw, 3rem);
      margin-bottom: clamp(10px, 3vw, 15px);
      color: var(--warning-color);
    }
    
    .card.restricted .restricted-overlay span {
      font-size: clamp(0.9rem, 3vw, 1.1rem);
      font-weight: 600;
    }

    /* Layout de Tarjetas en secciones internas */
    .section-content:not(#section-inicio) .cards-row {
      position: relative; 
      display: block; 
      min-height: 100px;
      margin-top: 0;
    }
    
    .movable-card-wrapper {
      position: absolute; 
      width: 48%; 
      min-height: 150px;
      cursor: move !important;
      padding: 0;
    }
    
    .movable-card-wrapper .card {
      margin: 0 !important; 
      height: 100% !important;
      transform: none !important; 
    }

    /* Estilos de Edición optimizados */
    .active-editable { 
      outline: 2px dashed var(--primary-color); 
    }

    /* Movable Text Box mejorado */
    .movable {
      position: absolute !important;
      z-index: 1000;
      border: none !important; 
      cursor: default !important;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-light);
      touch-action: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .movable.active-editable {
      border: 2px dashed var(--primary-color) !important;
      cursor: move !important;
    }
    
    .movable[contenteditable="true"] {
      cursor: text !important;
      outline: 2px dashed var(--success-color);
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    .text-box {
      padding: clamp(15px, 3vw, 20px);
      min-width: min(250px, 80vw);
      min-height: min(120px, 30vh);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      line-height: 1.6;
    }
    
    .text-box p { 
      margin: 0; 
    } 
    
    /* Cleanup para evitar saltos en texto estático */
    .editable-text:not([contenteditable="true"]):not(.movable) {
      border: 1px solid transparent !important; 
      padding: 5px;                           
      cursor: default;
    }
    
    .editable-text[contenteditable="true"]:not(.movable) {
      border: 1px dashed #ccc !important;
      padding: 5px; 
      cursor: text;
      outline: none !important; 
    }
    
    .hero-title.editable-text,
    .hero-subtitle.editable-text {
      padding: 5px !important;
      border: 1px solid transparent !important;
    }
    
    .hero-title.editable-text[contenteditable="true"],
    .hero-subtitle.editable-text[contenteditable="true"] {
      border: 1px dashed rgba(255, 255, 255, 0.5) !important;
      border-radius: 5px;
      padding: 5px !important;
    }
    
    /* Grid de tarjetas de inicio optimizado */
    .cards-row {
      --bs-gutter-x: clamp(1rem, 3vw, 1.5rem);
      --bs-gutter-y: clamp(1rem, 3vw, 1.5rem);
      display: flex;
      flex-wrap: wrap;
      position: relative;
    }
    
    /* CORRECCIÓN: Estilo específico para las tarjetas de inicio */
    #section-inicio .cards-row > .col {
      flex: 0 0 auto;
      width: 20%; 
      padding: calc(var(--bs-gutter-x) * .5);
      margin-top: var(--bs-gutter-y);
    }
    
    /* Botones mejorados con mejor área táctil */
    .btn-custom {
      border-radius: 8px;
      font-weight: 600;
      padding: clamp(0.5rem, 2vw, 0.6rem) clamp(1rem, 3vw, 1.2rem);
      transition: var(--transition);
      border: none;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }
    
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
    }
    
    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      background: transparent;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    /* Mejora para botones en dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .btn-custom:hover {
        transform: none;
      }
      
      .btn-custom:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
    }
    
    /* Estilos para el modo edición optimizados */
    .edit-mode-indicator {
      position: fixed;
      top: clamp(70px, 12vw, 80px);
      right: clamp(10px, 3vw, 20px);
      background: linear-gradient(135deg, var(--warning-color), #e0a800);
      color: var(--dark-color);
      padding: clamp(6px, 2vw, 8px) clamp(12px, 3vw, 15px);
      border-radius: 30px;
      font-size: clamp(0.75rem, 2.5vw, 0.85rem);
      z-index: 1050;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-weight: 600;
      display: flex;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .edit-mode-indicator i {
      margin-right: 8px;
    }
    
    /* Estilos para el login modal optimizados */
    .login-modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-radius: 0;
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      margin: constant(safe-area-inset-top) constant(safe-area-inset-right) constant(safe-area-inset-bottom) constant(safe-area-inset-left);
      margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    /* Estilos para elementos de arrastre optimizados */
    .ui-draggable-dragging {
      z-index: 10000 !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
      transform: scale(1.02);
    }
    
    .ui-resizable-handle {
      background-color: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
      width: clamp(10px, 3vw, 12px) !important;
      height: clamp(10px, 3vw, 12px) !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Animaciones optimizadas */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease;
    }
    
    /* Responsive Design mejorado */
    @media (max-width: 1200px) {
      #section-inicio .cards-row > .col {
        width: 33.333%;
      }
    }
    
    @media (max-width: 992px) {
      #editSidebar {
        width: min(280px, 80vw);
      }
      
      .navbar-collapse {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-top: 1rem;
        box-shadow: var(--box-shadow);
      }
    }
    
    @media (max-width: 768px) {
      #section-inicio .cards-row > .col {
        width: 50%;
      }
      
      .movable-card-wrapper {
        width: 100%;
        position: relative !important;
        margin-bottom: 1rem;
      }
      
      .navbar-brand-custom {
        font-size: 1.3rem;
      }
    }
    
    @media (max-width: 576px) {
      #section-inicio .cards-row > .col {
        width: 100%;
      }
      
      .card-body {
        padding: 1.25rem;
      }
      
      .edit-mode-indicator {
        top: 70px;
        right: 10px;
      }
      
      /* Mejoras específicas para móviles pequeños */
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
    }
    
    /* Soporte para orientación landscape en móviles */
    @media (max-height: 500px) and (orientation: landscape) {
      .navbar {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      
      .hero-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
      
      .hero-title {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .hero-subtitle {
        font-size: 0.9rem;
      }
    }
    
    /* Mejoras para tablets */
    @media (min-width: 768px) and (max-width: 1024px) {
      #section-inicio .cards-row > .col {
        width: 33.333%;
      }
      
      .hero-title {
        font-size: 2.2rem;
      }
      
      .hero-subtitle {
        font-size: 1.1rem;
      }
    }
    
    /* Soporte para navegadores WebKit (Safari) */
    @supports (-webkit-touch-callout: none) {
      .hero-section {
        -webkit-mask-image: -webkit-radial-gradient(white, black);
      }
      
      .card {
        -webkit-transform: translateZ(0);
      }
    }
    
    /* Mejoras para navegadores con soporte a scroll suave */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }
    
    /* Mejoras de accesibilidad */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Mejoras visuales adicionales */
    .section-title {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 700;
      margin-bottom: clamp(1rem, 3vw, 1.5rem);
      color: var(--secondary-color);
      position: relative;
      padding-bottom: 10px;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 4px;
      background: var(--primary-color);
      border-radius: 2px;
    }

    /* Estilos mejorados para secciones específicas */
    .section-content:not(#section-inicio) .cards-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .chart-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .progress-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .progress-card .progress {
      height: 12px;
      margin: 10px 0;
    }
    
    .data-table {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow-light);
    }
    
    .data-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }
    
    .form-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--box-shadow-light);
    }
    
    .form-card .form-label {
      font-weight: 600;
      color: var(--secondary-color);
    }
    
    .metric-card {
      text-align: center;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      background: white;
      box-shadow: var(--box-shadow-light);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .metric-label {
      font-size: 1rem;
      color: var(--secondary-color);
    }
    
    .metric-change {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .metric-change.positive {
      color: var(--success-color);
    }
    
    .metric-change.negative {
      color: var(--danger-color);
    }
    
    .report-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .report-card .report-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .report-card .report-date {
      color: var(--secondary-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .report-card .report-description {
      margin-bottom: 1.5rem;
    }
    
    .goal-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .goal-card .goal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .goal-card .goal-deadline {
      color: var(--secondary-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .goal-card .goal-progress {
      margin-bottom: 1rem;
    }
    
    .goal-card .goal-description {
      margin-bottom: 1.5rem;
    }
    
    /* Estilos para formularios de gestión */
    .form-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
      color: var(--secondary-color);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--light-gray);
    }
    
    /* Estilos para tablas de gestión */
    .management-table {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow-light);
    }
    
    .management-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }
    
    /* Estilos para dashboard */
    .dashboard-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      height: 100%;
    }
    
    .dashboard-card .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--secondary-color);
    }
    
    /* Estilos para filtros */
    .filter-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow-light);
      margin-bottom: 1.5rem;
    }
    
    .filter-section h6 {
      color: var(--secondary-color);
      margin-bottom: 1rem;
    }
    
    /* Estilos para indicadores de carga */
    .loading-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Estilos para mensajes de estado */
    .status-message {
      padding: 1rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
    }
    
    .status-success {
      background-color: rgba(40, 167, 69, 0.1);
      border-left: 4px solid var(--success-color);
      color: var(--success-color);
    }
    
    .status-error {
      background-color: rgba(220, 53, 69, 0.1);
      border-left: 4px solid var(--danger-color);
      color: var(--danger-color);
    }
    
    .status-info {
      background-color: rgba(23, 162, 184, 0.1);
      border-left: 4px solid var(--info-color);
      color: var(--info-color);
    }
  </style>
</head>
<body>
  <div id="editSidebar" class="bg-light d-none-temp p-3 shadow-sm" aria-hidden="true">
    <h5 class="text-primary mb-4"><i class="fas fa-tools"></i> Herramientas de Edición</h5>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-layer-group"></i> Elementos</h6>
        
        <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="showCardCustomizationDialog()">
          <i class="fas fa-credit-card me-1"></i> Añadir Tarjeta Personalizada
        </button>

        <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="addTextBox()">
          <i class="fas fa-square-plus me-1"></i> Agregar Cuadro de Texto
        </button>
        <button class="btn btn-sm btn-outline-danger w-100 mb-4" onclick="deleteSelectedElement()">
          <i class="fas fa-trash me-1"></i> Eliminar Seleccionado
        </button>
        <button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="deleteSelectedCard()">
          <i class="fas fa-trash-alt me-1"></i> Eliminar Tarjeta
        </button>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-arrows-alt"></i> Posición y Tamaño</h6>
        <label class="form-label small fw-bold">Posición (px)</label>
        <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">X</span>
            <input type="number" id="posLeftInput" class="form-control" min="0" oninput="changePosition('left', this.value)">
            <span class="input-group-text">Y</span>
            <input type="number" id="posTopInput" class="form-control" min="0" oninput="changePosition('top', this.value)">
        </div>
        <label class="form-label small fw-bold">Dimensiones (px)</label>
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Ancho</span>
            <input type="number" id="widthInput" class="form-control" min="50" oninput="changeSize('width', this.value)">
            <span class="input-group-text">Alto</span>
            <input type="number" id="heightInput" class="form-control" min="30" oninput="changeSize('height', this.value)">
        </div>
        <div class="alert alert-info py-1 small">
          Mueve con <strong>flechas</strong> (↑↓←→) para precisión de 1px.
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-font"></i> Formato</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('bold')" title="Negrita"><i class="fas fa-bold"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('italic')" title="Cursiva"><i class="fas fa-italic"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('underline')" title="Subrayado"><i class="fas fa-underline"></i></button>
          <button class="btn btn-sm btn-outline-primary" onclick="addLink()" title="Añadir enlace"><i class="fas fa-link"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-align-left"></i> Alineación</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyLeft')"><i class="fas fa-align-left"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyCenter')"><i class="fas fa-align-center"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyRight')"><i class="fas fa-align-right"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyFull')"><i class="fas fa-align-justify"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-list-ul"></i> Listas</h6>
        <div class="btn-group w-100 mb-4" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Viñetas"><i class="fas fa-list-ul"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Numeración"><i class="fas fa-list-ol"></i></button>
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-palette"></i> Estilos Visuales</h6>
        
        <label class="form-label small fw-bold">Tipo de Letra</label>
        <select class="form-select form-select-sm mb-3" id="fontFamilySelect" onchange="changeStyle('fontFamily', this.value)">
          <option value="Arial" style="font-family:Arial">Arial</option>
          <option value="Helvetica" style="font-family:Helvetica">Helvetica</option>
          <option value="Times New Roman" style="font-family:'Times New Roman'">Times New Roman</option>
          <option value="Courier New" style="font-family:'Courier New'">Courier New</option>
          <option value="Verdana" style="font-family:Verdana">Verdana</option>
          <option value="Georgia" style="font-family:Georgia">Georgia</option>
        </select>
        
        <label class="form-label small fw-bold">Tamaño de Fuente</label>
        <div class="input-group input-group-sm mb-3">
          <input type="number" id="fontSizeInput" class="form-control" min="8" max="128" placeholder="Ej: 16"
                 oninput="changeStyle('fontSize', this.value)"> 
          <span class="input-group-text">px</span>
        </div>

        <label class="form-label small fw-bold">Color de Texto</label>
        <input type="color" class="form-control form-control-sm mb-3"
               onchange="changeStyle('color', this.value)">

        <label class="form-label small fw-bold">Fondo</label>
        <input type="color" class="form-control form-control-sm mb-4"
               onchange="changeStyle('hiliteColor', this.value)"> 
    </div>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-history"></i> Historial</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="undoAction()" title="Deshacer"><i class="fas fa-undo"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="redoAction()" title="Rehacer"><i class="fas fa-redo"></i></button>
        </div>
    </div>

  </div>

  <!-- Modal para personalizar tarjeta -->
  <div class="modal fade" id="cardCustomizationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header login-modal-header text-white">
          <h5 class="modal-title"><i class="fas fa-palette me-2"></i> Personalizar Tarjeta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="cardCustomizationForm">
            <div class="mb-3">
              <label for="cardTitleInput" class="form-label">Título de la Tarjeta</label>
              <input type="text" class="form-control" id="cardTitleInput" value="Nueva Tarjeta" required>
            </div>
            <div class="mb-3">
              <label for="cardDescriptionInput" class="form-label">Descripción</label>
              <textarea class="form-control" id="cardDescriptionInput" rows="3">Descripción de la tarjeta personalizada.</textarea>
            </div>
            <div class="mb-3">
              <label for="cardIconSelect" class="form-label">Icono</label>
              <select class="form-select" id="cardIconSelect">
                <option value="fa-bullseye">Objetivo</option>
                <option value="fa-chart-line">Gráfico</option>
                <option value="fa-tasks">Tareas</option>
                <option value="fa-file-alt">Documento</option>
                <option value="fa-clipboard-list">Formulario</option>
                <option value="fa-recycle">Reciclaje</option>
                <option value="fa-leaf">Ecológico</option>
                <option value="fa-globe">Global</option>
                <option value="fa-users">Usuarios</option>
                <option value="fa-cog">Configuración</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="cardColorInput" class="form-label">Color de Fondo</label>
              <input type="color" class="form-control form-control-color" id="cardColorInput" value="#5D6D7E" title="Elige un color">
            </div>
            <div class="mb-3">
              <label for="cardLinkInput" class="form-label">Enlace (URL o #sección)</label>
              <input type="text" class="form-control" id="cardLinkInput" placeholder="#inicio o https://ejemplo.com">
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="cardRestrictedCheck">
              <label class="form-check-label" for="cardRestrictedCheck">
                Tarjeta restringida (requiere login)
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="createCustomCard()">Crear Tarjeta</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand navbar-brand-custom" href="#" onclick="showSection('inicio')">
        <i class="fas fa-recycle"></i> Gestión de Residuos Sólidos
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('inicio')">Inicio</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('metas')">Metas <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('indicadores')">Indicadores</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('avances')">Avances <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('reportes')">Reportes <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('formularios')">Formularios</a></li>
        </ul>
        <ul class="navbar-nav" id="loginBtnContainer">
          <li class="nav-item">
            <button class="btn btn-outline-light btn-custom" type="button" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
            </button>
          </li>
        </ul>
        <ul class="navbar-nav d-none" id="userNav">
          <li class="nav-item">
            <button id="editToggleBtn" class="btn btn-outline-light btn-custom me-2" onclick="toggleEditMode()">
              <i class="fas fa-edit me-1"></i> Modo Edición
            </button>
          </li>
          <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-bell"></i></a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i> <span id="userNameDisplay">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Gestión de Usuarios</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-address-card me-2"></i> Mi Perfil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="mainContentWrapper" class="container-fluid" style="margin-left:0;">
    <div class="container mt-4" id="mainContent">
      
      <div id="section-inicio" class="section-content">
        <div class="hero-section">
          <h1 class="hero-title editable-text" id="heroTitle">Sistema de Gestión de Residuos Sólidos</h1>
          <p class="hero-subtitle editable-text" id="heroSubtitle">
            Plataforma integral para monitorear indicadores, gestionar metas y generar reportes para una gestión ambiental eficiente y sostenible en el Cantón Daule.
          </p>
        </div>

        <div class="cards-row mt-3"> 
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #5d6d7e, #34495e);" data-card-link="#metas"> 
              <div class="card-body">
                <i class="fas fa-bullseye card-icon"></i>
                <h5 class="card-title editable-text text-white">Metas</h5>
                <p class="card-text editable-text text-white">Definición de objetivos a corto y largo plazo para la reducción de residuos.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #4CAF50, #2E7D32);" data-card-link="#indicadores"> 
              <div class="card-body">
                <i class="fas fa-chart-line card-icon"></i>
                <h5 class="card-title editable-text text-white">Indicadores</h5>
                <p class="card-text editable-text text-white">Métricas clave para medir el éxito del plan de gestión.</p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card restricted" style="background: linear-gradient(135deg, #f4d03f, #f39c12); color: #343a40;" data-card-link="#avances"> 
              <div class="card-body">
                <i class="fas fa-tasks card-icon"></i>
                <h5 class="card-title editable-text" style="color: #343a40;">Avances</h5>
                <p class="card-text editable-text" style="color: #343a40;">Registro del progreso y cumplimiento de las metas establecidas.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #3498db, #2980b9);" data-card-link="#reportes"> 
              <div class="card-body">
                <i class="fas fa-file-alt card-icon"></i>
                <h5 class="card-title editable-text text-white">Reportes</h5>
                <p class="card-text editable-text text-white">Generación automática de informes de impacto y sostenibilidad.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" data-card-link="#formularios"> 
              <div class="card-body">
                <i class="fas fa-clipboard-list card-icon"></i>
                <h5 class="card-title editable-text text-white">Formularios</h5>
                <p class="card-text editable-text text-white">Acceso a encuestas y herramientas de recolección de datos.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de Metas mejorada -->
      <div id="section-metas" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
          <h1 class="hero-title editable-text">Definición y Seguimiento de Metas</h1>
          <p class="hero-subtitle editable-text">
            Establezca metas SMART para la gestión de residuos. Monitoree la reducción y el reciclaje.
          </p>
        </div>
        
        <div id="metas-content">
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span class="ms-2">Cargando metas...</span>
          </div>
        </div>
      </div>

      <!-- Sección de Indicadores actualizada según propuesta -->
      <div id="section-indicadores" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #34495e 0%, #5d6d7e 100%);">
          <h1 class="hero-title editable-text">Indicadores de Gestión de Residuos Sólidos</h1>
          <p class="hero-subtitle editable-text">
            Sistema de indicadores para medir la eficiencia en la gestión de residuos sólidos en el cantón Daule.
          </p>
        </div>
        
        <div id="indicadores-content">
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span class="ms-2">Cargando indicadores...</span>
          </div>
        </div>
      </div>

      <!-- Sección de Avances actualizada según propuesta -->
      <div id="section-avances" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%); color: #343a40;">
          <h1 class="hero-title editable-text" style="color: #343a40;">Seguimiento de Avances del Plan de Gestión</h1>
          <p class="hero-subtitle editable-text" style="color: #343a40;">
            Monitoreo del cumplimiento de metas y evaluación del impacto de las acciones implementadas.
          </p>
        </div>
        
        <div id="avances-content">
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span class="ms-2">Cargando avances...</span>
          </div>
        </div>
      </div>

      <!-- Sección de Reportes actualizada según propuesta -->
      <div id="section-reportes" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
          <h1 class="hero-title editable-text">Sistema de Reportes y Documentación</h1>
          <p class="hero-subtitle editable-text">
            Generación de reportes técnicos, informes de gestión y documentación del sistema.
          </p>
        </div>
        
        <div id="reportes-content">
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span class="ms-2">Cargando reportes...</span>
          </div>
        </div>
      </div>

      <!-- Sección de Formularios simplificada -->
      <div id="section-formularios" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <h1 class="hero-title editable-text">Encuestas y Recolección de Datos en Campo</h1>
          <p class="hero-subtitle editable-text">
            Acceda a los formularios externos utilizados para la medición y el análisis del comportamiento ciudadano.
          </p>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6 mb-4">
            <div class="card text-white" style="background: linear-gradient(135deg, #2980b9, #2471a3);" data-card-link="https://tally.so/r/nGA7LO"> 
              <div class="card-body">
                <i class="fas fa-clipboard-check card-icon"></i>
                <h5 class="card-title editable-text text-white">ENCUESTA COMPORTAMIENTO PROAMBIENTAL</h5>
                <p class="card-text editable-text text-white">
                    Formulario para medir la actitud ciudadana hacia el reciclaje y la autosustentabilidad.
                </p>
                <div class="mt-3">
                  <span class="badge bg-light text-dark me-2 editable-text">47 preguntas</span>
                  <span class="badge bg-light text-dark editable-text">10 min aprox.</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 mb-4">
            <div class="card text-white" style="background: linear-gradient(135deg, #27ae60, #229954);" data-card-link="https://tally.so/r/3N1M0O"> 
              <div class="card-body">
                <i class="fas fa-weight card-icon"></i>
                <h5 class="card-title editable-text text-white">MEDICIÓN DE DESECHOS SÓLIDOS (Daule)</h5>
                <p class="card-text editable-text text-white">
                    Encuesta técnica para la medición y caracterización de los desechos sólidos en la comunidad.
                </p>
                <div class="mt-3">
                  <span class="badge bg-light text-dark me-2 editable-text">18 preguntas</span>
                  <span class="badge bg-light text-dark editable-text">2 min aprox.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header login-modal-header text-white">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i> Acceso al Sistema</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="inputEmail" value="a@ug.com" required>
            </div>
            <div class="mb-3">
              <label for="inputPassword" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="inputPassword" value="1234" required>
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-success mt-3 btn-custom" onclick="handleLogin()">Ingresar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://dutapywxsiuxboqsjqvf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4';
    
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Variables globales
    let isEditMode = false;
    let isLoggedIn = false;
    let savedRange = null;
    let activeEditable = null;
    const MOVE_STEP = 1;
    const CONTENT_PADDING = 30;
    const RESTRICTED_SECTIONS = ['metas', 'avances', 'reportes'];
    
    // Datos de la aplicación
    let appData = {
      metas: [],
      indicadores: [],
      avances: [],
      reportes: [],
      usuarios: []
    };
    
    // Historial de acciones para undo/redo
    let actionHistory = [];
    let currentHistoryIndex = -1;
    const MAX_HISTORY_SIZE = 50;
    
    // Sistema de navegación
    let navigationHistory = [];
    let currentNavigationIndex = -1;

    // Detectar dispositivo táctil
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // --- Sistema de Datos con Supabase ---
    
    // Cargar todos los datos de la aplicación
    async function loadAppData() {
      try {
        // Cargar metas
        const { data: metasData, error: metasError } = await supabase
          .from('metas')
          .select('*')
          .order('fecha_creacion', { ascending: false });
          
        if (!metasError) {
          appData.metas = metasData || [];
          renderMetas();
        } else {
          console.error('Error cargando metas:', metasError);
        }
        
        // Cargar indicadores
        const { data: indicadoresData, error: indicadoresError } = await supabase
          .from('indicadores')
          .select('*')
          .order('categoria', { ascending: true });
          
        if (!indicadoresError) {
          appData.indicadores = indicadoresData || [];
          renderIndicadores();
        } else {
          console.error('Error cargando indicadores:', indicadoresError);
        }
        
        // Cargar avances
        const { data: avancesData, error: avancesError } = await supabase
          .from('avances')
          .select('*, metas(nombre)')
          .order('fecha_registro', { ascending: false });
          
        if (!avancesError) {
          appData.avances = avancesData || [];
          renderAvances();
        } else {
          console.error('Error cargando avances:', avancesError);
        }
        
        // Cargar reportes
        const { data: reportesData, error: reportesError } = await supabase
          .from('reportes')
          .select('*')
          .order('fecha_generacion', { ascending: false });
          
        if (!reportesError) {
          appData.reportes = reportesData || [];
          renderReportes();
        } else {
          console.error('Error cargando reportes:', reportesError);
        }
        
      } catch (error) {
        console.error('Error cargando datos de la aplicación:', error);
      }
    }
    
    // Renderizar metas
    function renderMetas() {
      const container = document.getElementById('metas-content');
      if (!container) return;
      
      if (appData.metas.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No hay metas registradas en el sistema.
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="row mt-4">
          <div class="col-md-8">
            ${appData.metas.map(meta => `
              <div class="goal-card">
                <div class="goal-title">${meta.nombre}</div>
                <div class="goal-deadline">Fecha límite: ${new Date(meta.fecha_limite).toLocaleDateString()}</div>
                <div class="goal-progress">
                  <div class="d-flex justify-content-between mb-1">
                    <span>Progreso actual</span>
                    <span>${meta.progreso_actual}%</span>
                  </div>
                  <div class="progress">
                    <div class="progress-bar bg-success" role="progressbar" style="width: ${meta.progreso_actual}%" 
                         aria-valuenow="${meta.progreso_actual}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
                <div class="goal-description">
                  ${meta.descripcion}
                </div>
                <div class="d-flex justify-content-between">
                  <button class="btn btn-sm btn-outline-primary" onclick="viewMetaDetails(${meta.id})">Ver detalles</button>
                  <button class="btn btn-sm btn-outline-success" onclick="updateMetaProgress(${meta.id})">Actualizar progreso</button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="col-md-4">
            <div class="metric-card mb-4">
              <i class="fas fa-bullseye fa-2x text-primary"></i>
              <div class="metric-value">${appData.metas.length}</div>
              <div class="metric-label">Metas Activas</div>
            </div>
            
            <div class="metric-card mb-4">
              <i class="fas fa-check-circle fa-2x text-success"></i>
              <div class="metric-value">${appData.metas.filter(m => m.progreso_actual >= 100).length}</div>
              <div class="metric-label">Metas Completadas</div>
            </div>
            
            <div class="metric-card mb-4">
              <i class="fas fa-clock fa-2x text-warning"></i>
              <div class="metric-value">${appData.metas.filter(m => m.progreso_actual > 0 && m.progreso_actual < 100).length}</div>
              <div class="metric-label">Metas en Progreso</div>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Renderizar indicadores
    function renderIndicadores() {
      const container = document.getElementById('indicadores-content');
      if (!container) return;
      
      if (appData.indicadores.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No hay indicadores registrados en el sistema.
          </div>
        `;
        return;
      }
      
      // Agrupar indicadores por categoría
      const indicadoresPorCategoria = {};
      appData.indicadores.forEach(ind => {
        if (!indicadoresPorCategoria[ind.categoria]) {
          indicadoresPorCategoria[ind.categoria] = [];
        }
        indicadoresPorCategoria[ind.categoria].push(ind);
      });
      
      let html = '';
      
      // Métricas principales
      html += `
        <div class="row mt-4">
          <div class="col-md-3 mb-4">
            <div class="metric-card">
              <i class="fas fa-weight fa-2x text-primary"></i>
              <div class="metric-value">1.2 kg</div>
              <div class="metric-label">Generación Per Cápita</div>
              <div class="metric-change positive">+5.3%</div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="metric-card">
              <i class="fas fa-recycle fa-2x text-success"></i>
              <div class="metric-value">32%</div>
              <div class="metric-label">Tasa de Reciclaje</div>
              <div class="metric-change positive">+8.7%</div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="metric-card">
              <i class="fas fa-truck fa-2x text-info"></i>
              <div class="metric-value">87%</div>
              <div class="metric-label">Cobertura de Recolección</div>
              <div class="metric-change positive">+2.1%</div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="metric-card">
              <i class="fas fa-landmark fa-2x text-warning"></i>
              <div class="metric-value">45%</div>
              <div class="metric-label">Residuos en Relleno</div>
              <div class="metric-change negative">-3.2%</div>
            </div>
          </div>
        </div>
      `;
      
      // Tablas por categoría
      Object.keys(indicadoresPorCategoria).forEach(categoria => {
        const indicadoresCategoria = indicadoresPorCategoria[categoria];
        
        html += `
          <div class="row mt-4">
            <div class="col-12">
              <div class="form-section">
                <h5>Indicadores de ${categoria}</h5>
                <div class="table-responsive">
                  <table class="table table-striped management-table">
                    <thead>
                      <tr>
                        <th>Indicador</th>
                        <th>Descripción</th>
                        <th>Fórmula</th>
                        <th>Unidad</th>
                        <th>Meta</th>
                        <th>Valor Actual</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${indicadoresCategoria.map(ind => `
                        <tr>
                          <td>${ind.nombre}</td>
                          <td>${ind.descripcion}</td>
                          <td>${ind.formula}</td>
                          <td>${ind.unidad}</td>
                          <td>${ind.meta}</td>
                          <td>${ind.valor_actual}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Renderizar avances
    function renderAvances() {
      const container = document.getElementById('avances-content');
      if (!container) return;
      
      if (appData.avances.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No hay avances registrados en el sistema.
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="row mt-4">
          <div class="col-md-12">
            <div class="filter-section">
              <h6>Filtros de Avances</h6>
              <div class="row">
                <div class="col-md-4">
                  <label class="form-label">Periodo</label>
                  <select class="form-select" id="avancePeriodo">
                    <option>Último mes</option>
                    <option>Último trimestre</option>
                    <option>Último año</option>
                    <option>Personalizado</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Tipo de Meta</label>
                  <select class="form-select" id="avanceTipo">
                    <option>Todas</option>
                    <option>Reducción</option>
                    <option>Reciclaje</option>
                    <option>Educación</option>
                    <option>Infraestructura</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Estado</label>
                  <select class="form-select" id="avanceEstado">
                    <option>Todos</option>
                    <option>En progreso</option>
                    <option>Completado</option>
                    <option>Retrasado</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="dashboard-card">
              <div class="card-title">Avance General del Plan</div>
              <div class="progress mb-3" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">
                  <span class="fw-bold">65%</span>
                </div>
              </div>
              <div class="row text-center">
                <div class="col-4">
                  <div class="metric-value" style="font-size: 1.5rem;">${appData.metas.length}</div>
                  <div class="metric-label">Metas Totales</div>
                </div>
                <div class="col-4">
                  <div class="metric-value" style="font-size: 1.5rem;">${appData.metas.filter(m => m.progreso_actual > 0 && m.progreso_actual < 100).length}</div>
                  <div class="metric-label">En Progreso</div>
                </div>
                <div class="col-4">
                  <div class="metric-value" style="font-size: 1.5rem;">${appData.metas.filter(m => m.progreso_actual >= 100).length}</div>
                  <div class="metric-label">Completadas</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="dashboard-card">
              <div class="card-title">Próximos Vencimientos</div>
              <div class="list-group list-group-flush">
                ${appData.metas
                  .filter(m => new Date(m.fecha_limite) > new Date())
                  .sort((a, b) => new Date(a.fecha_limite) - new Date(b.fecha_limite))
                  .slice(0, 3)
                  .map(meta => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-1">${meta.nombre}</h6>
                        <small class="text-muted">Vence: ${new Date(meta.fecha_limite).toLocaleDateString()}</small>
                      </div>
                      <span class="badge bg-warning rounded-pill">${meta.progreso_actual}%</span>
                    </div>
                  `).join('')}
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="form-section">
              <h5>Detalle de Avances por Meta</h5>
              <div class="table-responsive">
                <table class="table table-striped management-table">
                  <thead>
                    <tr>
                      <th>Meta</th>
                      <th>Fecha Inicio</th>
                      <th>Fecha Límite</th>
                      <th>Progreso</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${appData.metas.map(meta => {
                      let estadoBadge = '';
                      if (meta.progreso_actual >= 100) {
                        estadoBadge = '<span class="badge bg-success">Completada</span>';
                      } else if (new Date(meta.fecha_limite) < new Date()) {
                        estadoBadge = '<span class="badge bg-danger">Retrasada</span>';
                      } else if (meta.progreso_actual > 0) {
                        estadoBadge = '<span class="badge bg-warning">En progreso</span>';
                      } else {
                        estadoBadge = '<span class="badge bg-info">No iniciada</span>';
                      }
                      
                      return `
                        <tr>
                          <td>${meta.nombre}</td>
                          <td>${new Date(meta.fecha_creacion).toLocaleDateString()}</td>
                          <td>${new Date(meta.fecha_limite).toLocaleDateString()}</td>
                          <td>
                            <div class="progress" style="height: 10px;">
                              <div class="progress-bar bg-success" role="progressbar" style="width: ${meta.progreso_actual}%" 
                                   aria-valuenow="${meta.progreso_actual}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                          </td>
                          <td>${estadoBadge}</td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewMetaDetails(${meta.id})">Detalles</button>
                            <button class="btn btn-sm btn-outline-success" onclick="updateMetaProgress(${meta.id})">Actualizar</button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Renderizar reportes
    function renderReportes() {
      const container = document.getElementById('reportes-content');
      if (!container) return;
      
      let html = `
        <div class="row mt-4">
          <div class="col-md-12">
            <div class="filter-section">
              <h6>Generar Nuevo Reporte</h6>
              <div class="row">
                <div class="col-md-3">
                  <label class="form-label">Tipo de Reporte</label>
                  <select class="form-select" id="reportType">
                    <option value="indicadores">Reporte de Indicadores</option>
                    <option value="avances">Reporte de Avances</option>
                    <option value="mensual">Reporte Mensual</option>
                    <option value="trimestral">Reporte Trimestral</option>
                    <option value="anual">Reporte Anual</option>
                    <option value="especial">Reporte Especial</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Periodo</label>
                  <select class="form-select" id="reportPeriod">
                    <option value="mes">Último mes</option>
                    <option value="trimestre">Último trimestre</option>
                    <option value="anio">Último año</option>
                    <option value="personalizado">Personalizado</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Formato</label>
                  <select class="form-select" id="reportFormat">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                    <option value="word">Word</option>
                  </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button class="btn btn-success w-100" onclick="generateReport()">
                    <i class="fas fa-download me-2"></i> Generar Reporte
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      if (appData.reportes.length > 0) {
        html += `
          <div class="row mt-4">
            <div class="col-12">
              <div class="form-section">
                <h5>Reportes del Sistema</h5>
                <div class="table-responsive">
                  <table class="table table-striped management-table">
                    <thead>
                      <tr>
                        <th>Reporte</th>
                        <th>Descripción</th>
                        <th>Frecuencia</th>
                        <th>Última Generación</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${appData.reportes.map(reporte => `
                        <tr>
                          <td>${reporte.nombre}</td>
                          <td>${reporte.descripcion}</td>
                          <td>${reporte.frecuencia}</td>
                          <td>${new Date(reporte.fecha_generacion).toLocaleDateString()}</td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewReport(${reporte.id})">Vista Previa</button>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadReport(${reporte.id})">Descargar</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        html += `
          <div class="alert alert-info mt-4">
            <i class="fas fa-info-circle me-2"></i>
            No hay reportes generados en el sistema.
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // Funciones auxiliares para acciones
    function viewMetaDetails(metaId) {
      alert(`Ver detalles de la meta ID: ${metaId}`);
      // Implementar lógica para mostrar detalles de la meta
    }
    
    function updateMetaProgress(metaId) {
      const nuevaProgresion = prompt('Ingrese el nuevo porcentaje de progreso:');
      if (nuevaProgresion !== null && !isNaN(nuevaProgresion)) {
        alert(`Actualizando progreso de la meta ID: ${metaId} a ${nuevaProgresion}%`);
        // Implementar lógica para actualizar el progreso en Supabase
      }
    }
    
    function generateReport() {
      const reportType = document.getElementById('reportType').value;
      const reportPeriod = document.getElementById('reportPeriod').value;
      const reportFormat = document.getElementById('reportFormat').value;
      
      alert(`Generando reporte de tipo: ${reportType} para el periodo: ${reportPeriod} en formato: ${reportFormat}`);
      // Implementar lógica para generar reportes
    }
    
    function viewReport(reporteId) {
      alert(`Vista previa del reporte ID: ${reporteId}`);
      // Implementar lógica para vista previa de reportes
    }
    
    function downloadReport(reporteId) {
      alert(`Descargando reporte ID: ${reporteId}`);
      // Implementar lógica para descargar reportes
    }

    // --- Sistema de Historial de Acciones ---
    function saveAction(action) {
      if (currentHistoryIndex < actionHistory.length - 1) {
        actionHistory = actionHistory.slice(0, currentHistoryIndex + 1);
      }
      
      actionHistory.push(action);
      currentHistoryIndex = actionHistory.length - 1;
      
      if (actionHistory.length > MAX_HISTORY_SIZE) {
        actionHistory.shift();
        currentHistoryIndex--;
      }
      
      saveToSupabase();
    }
    
    function undoAction() {
      if (currentHistoryIndex >= 0) {
        const action = actionHistory[currentHistoryIndex];
        if (action && action.undo) {
          action.undo();
          currentHistoryIndex--;
          saveToSupabase();
        }
      }
    }
    
    function redoAction() {
      if (currentHistoryIndex < actionHistory.length - 1) {
        currentHistoryIndex++;
        const action = actionHistory[currentHistoryIndex];
        if (action && action.redo) {
          action.redo();
          saveToSupabase();
        }
      }
    }

    // --- Sistema de Navegación ---
    function addToNavigationHistory(sectionId) {
      if (currentNavigationIndex < navigationHistory.length - 1) {
        navigationHistory = navigationHistory.slice(0, currentNavigationIndex + 1);
      }
      
      navigationHistory.push(sectionId);
      currentNavigationIndex = navigationHistory.length - 1;
      
      if (navigationHistory.length > 20) {
        navigationHistory.shift();
        currentNavigationIndex--;
      }
    }
    
    function navigateBack() {
      if (currentNavigationIndex > 0) {
        currentNavigationIndex--;
        const sectionId = navigationHistory[currentNavigationIndex];
        showSection(sectionId, false);
      }
    }
    
    function navigateForward() {
      if (currentNavigationIndex < navigationHistory.length - 1) {
        currentNavigationIndex++;
        const sectionId = navigationHistory[currentNavigationIndex];
        showSection(sectionId, false);
      }
    }

    // --- Sistema de Supabase ---
    async function saveToSupabase() {
      if (!isLoggedIn) return;
      
      const saveData = {
        content: document.getElementById('mainContent').innerHTML,
        actionHistory: actionHistory,
        currentHistoryIndex: currentHistoryIndex,
        navigationHistory: navigationHistory,
        currentNavigationIndex: currentNavigationIndex,
        last_updated: new Date().toISOString()
      };
      
      try {
        const { data, error } = await supabase
          .from('system_data')
          .upsert({ 
            id: 1, 
            data: saveData,
            updated_at: new Date().toISOString()
          });
          
        if (error) {
          console.error('Error saving to Supabase:', error);
        } else {
          console.log('Data saved to Supabase successfully');
        }
      } catch (error) {
        console.error('Error saving to Supabase:', error);
      }
    }
    
    async function loadFromSupabase() {
      try {
        const { data, error } = await supabase
          .from('system_data')
          .select('*')
          .eq('id', 1)
          .single();
          
        if (error) {
          console.error('Error loading from Supabase:', error);
          return;
        }
        
        if (data && data.data) {
          const savedData = data.data;
          
          if (savedData.content) {
            document.getElementById('mainContent').innerHTML = savedData.content;
          }
          
          if (savedData.actionHistory) {
            actionHistory = savedData.actionHistory;
            currentHistoryIndex = savedData.currentHistoryIndex || -1;
          }
          
          if (savedData.navigationHistory) {
            navigationHistory = savedData.navigationHistory;
            currentNavigationIndex = savedData.currentNavigationIndex || -1;
          }
          
          initializeMovableElements();
          setTimeout(updateContentHeight, 100);
        }
      } catch (error) {
        console.error('Error loading from Supabase:', error);
      }
    }
    
    // Suscribirse a cambios en tiempo real
    function subscribeToChanges() {
      supabase
        .channel('system_changes')
        .on('postgres_changes', 
          { 
            event: '*', 
            schema: 'public', 
            table: 'system_data' 
          }, 
          payload => {
            console.log('Change received!', payload);
            if (payload.new && payload.new.id === 1) {
              loadFromSupabase();
            }
          }
        )
        .subscribe();
        
      // Suscribirse a cambios en las tablas de datos
      ['metas', 'indicadores', 'avances', 'reportes'].forEach(table => {
        supabase
          .channel(`${table}_changes`)
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: table 
            }, 
            payload => {
              console.log(`Change in ${table}:`, payload);
              loadAppData(); // Recargar datos cuando hay cambios
            }
          )
          .subscribe();
      });
    }

    // --- Lógica de Navegación (SPA) ---
    function showSection(sectionId, addToHistory = true) {
        if (RESTRICTED_SECTIONS.includes(sectionId) && !isLoggedIn) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 p-3 bg-warning text-dark rounded shadow';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Inicia sesión para acceder a esta sección</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
            
            if (sectionId !== 'inicio') {
                 showSection('inicio', addToHistory);
            }
            return;
        }

        if (addToHistory) {
          addToNavigationHistory(sectionId);
        }

        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
        });
        const sectionToShow = document.getElementById(`section-${sectionId}`);
        if (sectionToShow) {
            sectionToShow.style.display = 'block';
        }

        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false);
            else activeEditable.removeAttribute('contenteditable');
            activeEditable = null;
        }
        updatePositionInputs();
        
        setTimeout(updateContentHeight, 50);
        initializeMovableElements();
    }
    
    function navigateToCardLink(link) {
        if (!link) return;

        if (link.startsWith('http')) {
            window.open(link, '_blank');
        } else if (link.startsWith('#')) {
            const sectionId = link.substring(1);
            showSection(sectionId);
        }
    }

    // --- FUNCIÓN MEJORADA: Cálculo optimizado de altura ---
    function updateContentHeight() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        const movableElements = activeSection.querySelectorAll('.movable, .movable-card-wrapper');
        let maxBottom = 0;

        if (movableElements.length === 0) {
            // Si no hay elementos movibles, usar el contenido estático
            const staticContent = activeSection.querySelector('.hero-section');
            if (staticContent) {
                const rect = staticContent.getBoundingClientRect();
                const containerRect = activeSection.getBoundingClientRect();
                const relativeTop = rect.top - containerRect.top;
                const height = rect.height;
                maxBottom = relativeTop + height;
            }
            
            // Aplicar altura mínima solo si hay contenido
            const newMinHeight = maxBottom > 0 ? maxBottom + CONTENT_PADDING : 'auto';
            document.getElementById('mainContent').style.minHeight = newMinHeight;
            return; 
        }

        movableElements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const containerRect = activeSection.getBoundingClientRect();
            const relativeTop = rect.top - containerRect.top;
            const height = el.offsetHeight;
            const bottom = relativeTop + height;
            maxBottom = Math.max(maxBottom, bottom);
        });

        const newMinHeight = maxBottom + CONTENT_PADDING;
        document.getElementById('mainContent').style.minHeight = `${newMinHeight}px`;
    }

    // --- Funciones de Formato, Posición y Elementos Movibles ---
    function saveSelection() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      if (activeEditable && activeEditable.getAttribute('contenteditable') === 'true' && activeEditable.contains(sel.focusNode)) {
        savedRange = sel.getRangeAt(0).cloneRange();
      }
    }
    
    function restoreSelection() {
      if (!savedRange) return;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
    }
    
    document.addEventListener('mouseup', saveSelection);
    document.addEventListener('keyup', saveSelection);

    function formatText(command) {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection(); 
            document.execCommand(command, false, null);
            saveSelection();
        }
    }
    
    function addLink() {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection();
            
            const url = prompt("Introduce la URL:", "http://");
            if (url && url !== "http://") document.execCommand("createLink", false, url);
            saveSelection();
        }
    }
    
    function changeStyle(property, value) {
        if (!activeEditable || !isEditMode) return;
        
        const targetElement = activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper');

        if (targetElement) {
             setMovableTextEditMode(targetElement, true);
        } else if (!activeEditable.hasAttribute('contenteditable')) {
            activeEditable.setAttribute('contenteditable', 'true');
        }
        
        activeEditable.focus();
        restoreSelection();

        const sel = window.getSelection();
        let rangeEmpty = !sel.rangeCount || sel.isCollapsed || sel.toString().trim() === '';

        if (property === 'hiliteColor') {
            if (!rangeEmpty) {
                document.execCommand('hiliteColor', false, value);
            } else if (activeEditable.closest('.card')) {
                activeEditable.closest('.card').style.backgroundColor = value;
            } else if (activeEditable.classList.contains('movable')) {
                activeEditable.style.backgroundColor = value;
            }
        } else if (property === 'color') {
            document.execCommand('foreColor', false, value);
        } else if (property === 'fontSize') {
            const size = parseInt(value, 10);
            if (isNaN(size) || size < 8 || size > 128) return;

            document.execCommand('fontSize', false, '7');
            const fonts = activeEditable.getElementsByTagName('font');
            for (let i = 0; i < fonts.length; i++) {
                if (fonts[i].size == '7') {
                    if (activeEditable.contains(fonts[i])) {
                        fonts[i].removeAttribute('size');
                        fonts[i].style.fontSize = `${size}px`;
                    }
                }
            }
        } else if (property === 'fontFamily') {
            document.execCommand('fontName', false, value);
        }

        saveSelection();
        activeEditable.focus();
    }
    
    function updatePositionInputs() {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const left = parseFloat(target.style.left.replace('px', '')) || 0;
            const top = parseFloat(target.style.top.replace('px', '')) || 0;
            const width = parseFloat(target.style.width.replace('px', '')) || target.offsetWidth;
            const height = parseFloat(target.style.height.replace('px', '')) || target.offsetHeight;

            document.getElementById('posLeftInput').value = Math.round(left);
            document.getElementById('posTopInput').value = Math.round(top);
            document.getElementById('widthInput').value = Math.round(width);
            document.getElementById('heightInput').value = Math.round(height);
        } else {
            document.getElementById('posLeftInput').value = '';
            document.getElementById('posTopInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('heightInput').value = '';
        }
    }

    function changePosition(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function changeSize(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function setMovableTextEditMode(el, enable) {
        if (!el || !$(el).data('ui-draggable')) return;

        if (enable) {
            if (activeEditable) activeEditable.setAttribute('contenteditable', 'true');
            $(el).draggable('disable');
            $(el).resizable('disable');
            el.classList.add('active-editable');
        } else {
            if (activeEditable) activeEditable.removeAttribute('contenteditable');
            $(el).draggable('enable');
            $(el).resizable('enable');
            el.classList.remove('active-editable'); 
        }
    }
    
    // FUNCIÓN MEJORADA: Hacer elementos arrastrables y redimensionables sin límites
    function makeElementDraggableAndResizable(el) {
        const container = document.querySelector('.section-content[style*="block"]');
        if (!container) return;

        // Calcular límites dinámicos basados en el contenido actual
        const containerHeight = container.scrollHeight;
        const containerWidth = container.offsetWidth;
        
        // Configuración de arrastre sin límites verticales
        const dragOptions = {
            containment: [0, 0, containerWidth, containerHeight + 1000], // Permitir movimiento hacia abajo
            scroll: false,
            start: function(event, ui) { 
                if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            drag: function(event, ui) { 
                updateContentHeight(); 
            },
            stop: function(event, ui) { 
                updatePositionInputs(); 
                updateContentHeight(); 
            }
        };

        if (isTouchDevice) {
            dragOptions.delay = 200;
            dragOptions.distance = 10;
        }

        $(el).draggable(dragOptions);
        
        $(el).resizable({
            handles: 'all',
            minWidth: 100,
            minHeight: 50,
            disabled: el.closest('#section-inicio') || el.classList.contains('col'), 
            start: function(event, ui) {
                 if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            resize: function(event, ui) { 
                updatePositionInputs(); 
                updateContentHeight(); 
            },
            stop: function(event, ui) { 
                updateContentHeight(); 
            }
        });
    }

    function initializeMovableElements() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        activeSection.querySelectorAll('.movable, .movable-card-wrapper').forEach(el => {
            if (isEditMode) makeElementDraggableAndResizable(el);
            else { 
                if ($(el).data('ui-draggable')) { $(el).draggable('destroy'); }
                if ($(el).data('ui-resizable')) { $(el).resizable('destroy'); }
            }
        });
    }

    function getActiveContentContainer() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        return activeSection || document.getElementById('section-inicio');
    }
    
    function addTextBox() {
        const container = getActiveContentContainer();
        const newBox = document.createElement("div");
        newBox.className = "editable-text movable text-box"; 
        newBox.setAttribute("contenteditable", "false"); 
        newBox.innerHTML = "<p>Doble clic para editar este texto...</p>"; 

        newBox.style.position = 'absolute';
        newBox.style.width = '200px'; 
        newBox.style.minHeight = '100px';
        
        const heroSection = container.querySelector('.hero-section');
        const staticContentBottom = heroSection ? heroSection.getBoundingClientRect().bottom - container.getBoundingClientRect().top + 20 : 100;
        
        newBox.style.left = '100px';
        newBox.style.top = `${staticContentBottom}px`; 
        newBox.style.backgroundColor = 'white'; 

        container.appendChild(newBox);
        
        if (isEditMode) {
            makeElementDraggableAndResizable(newBox);
            
            if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
                else activeEditable.removeAttribute('contenteditable');
            }
            activeEditable = newBox;
            updatePositionInputs();
            newBox.classList.add('active-editable');

            setMovableTextEditMode(newBox, true);
            newBox.focus();
            updateContentHeight();
            
            saveAction({
                type: 'addTextBox',
                element: newBox.outerHTML,
                container: container.id,
                undo: function() {
                    newBox.remove();
                    updateContentHeight();
                },
                redo: function() {
                    container.appendChild(newBox);
                    makeElementDraggableAndResizable(newBox);
                    updateContentHeight();
                }
            });
        }
    }

    // --- Funciones para Tarjetas Personalizables ---
    function showCardCustomizationDialog() {
        const modal = new bootstrap.Modal(document.getElementById('cardCustomizationModal'));
        modal.show();
    }

    function createCustomCard() {
        const title = document.getElementById('cardTitleInput').value || 'Nueva Tarjeta';
        const description = document.getElementById('cardDescriptionInput').value || 'Descripción de la tarjeta personalizada.';
        const icon = document.getElementById('cardIconSelect').value;
        const color = document.getElementById('cardColorInput').value;
        const link = document.getElementById('cardLinkInput').value;
        const isRestricted = document.getElementById('cardRestrictedCheck').checked;
        
        const rgb = hexToRgb(color);
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        const textColor = brightness > 128 ? '#343a40' : 'white';
        
        const activeSection = getActiveContentContainer();
        
        let cardsRow = activeSection.querySelector('.cards-row');
        if (!cardsRow) {
            cardsRow = document.createElement('div');
            cardsRow.className = 'cards-row mt-4';
            activeSection.appendChild(cardsRow);
        }

        const isHomeSection = activeSection.id === 'section-inicio';
        const colClass = isHomeSection ? 'col' : 'movable-card-wrapper';
        
        const newCol = document.createElement('div');
        newCol.className = colClass;
        
        const newCard = document.createElement('div');
        newCard.className = textColor === 'white' ? 'card text-white h-100' : 'card h-100';
        newCard.style.backgroundColor = color;
        newCard.dataset.cardLink = link || '';
        
        if (isRestricted) {
            newCard.classList.add('restricted');
        }

        if (!isHomeSection) {
            const movableElements = cardsRow.querySelectorAll('.movable-card-wrapper');
            let maxTop = 0;
            if (movableElements.length > 0) {
                 movableElements.forEach(el => {
                    const top = parseFloat(el.style.top.replace('px', '')) || 0;
                    const height = el.offsetHeight || 0;
                    maxTop = Math.max(maxTop, top + height);
                });
            } else {
                maxTop = 0;
            }
            newCol.style.position = 'absolute';
            newCol.style.top = `${maxTop + 20}px`; 
            newCol.style.left = '0px';
            newCol.style.width = '48%';
            newCol.style.minHeight = '150px';
        }
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const cardIcon = document.createElement('i');
        cardIcon.className = `fas ${icon} card-icon`;
        
        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title editable-text';
        cardTitle.textContent = title;
        cardTitle.style.color = textColor;

        const cardText = document.createElement('p');
        cardText.className = 'card-text editable-text';
        cardText.textContent = description;
        cardText.style.color = textColor;

        cardBody.appendChild(cardIcon);
        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        newCard.appendChild(cardBody);
        
        if (isRestricted) {
            const restrictedOverlay = document.createElement('div');
            restrictedOverlay.className = 'restricted-overlay';
            restrictedOverlay.innerHTML = `
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
            `;
            newCard.appendChild(restrictedOverlay);
        }
        
        newCol.appendChild(newCard);
        cardsRow.appendChild(newCol);
        
        if (isEditMode) {
             if (!isHomeSection) {
                 makeElementDraggableAndResizable(newCol);
             }

             // CORRECCIÓN: Mejor manejo de la selección para tarjetas personalizadas
             if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
            }
             
             // Marcar los elementos como editables pero sin activar el modo de edición inmediatamente
             newCard.classList.add('active-editable');
             cardTitle.classList.add('active-editable');
             cardText.classList.add('active-editable');
             
             updateContentHeight();
             updatePositionInputs();
             
             saveAction({
                 type: 'addCard',
                 element: newCol.outerHTML,
                 container: cardsRow.id || cardsRow.className,
                 undo: function() {
                     newCol.remove();
                     updateContentHeight();
                 },
                 redo: function() {
                     cardsRow.appendChild(newCol);
                     if (!isHomeSection) {
                         makeElementDraggableAndResizable(newCol);
                     }
                     updateContentHeight();
                 }
             });
        }
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('cardCustomizationModal'));
        modal.hide();
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : {r: 0, g: 0, b: 0};
    }

    // --- FUNCIONES MEJORADAS DE ELIMINACIÓN ---
    function deleteSelectedElement() {
      if (activeEditable) {
        const elementToDelete = activeEditable;
        const parentElement = elementToDelete.parentElement;
        
        const elementCopy = elementToDelete.cloneNode(true);
        
        const actionInfo = {
            type: 'deleteElement',
            element: elementCopy.outerHTML,
            parent: parentElement.outerHTML.substring(0, 100),
            elementId: elementToDelete.id || '',
            elementClass: elementToDelete.className,
            undo: function() {
                if (parentElement) {
                    parentElement.appendChild(elementCopy);
                    if (isEditMode) {
                        if (elementCopy.classList.contains('movable') || elementCopy.classList.contains('movable-card-wrapper')) {
                            makeElementDraggableAndResizable(elementCopy);
                        }
                    }
                    updateContentHeight();
                }
            },
            redo: function() {
                if (elementCopy.parentElement) {
                    elementCopy.remove();
                    updateContentHeight();
                }
            }
        };
        
        elementToDelete.remove();
        activeEditable = null;
        updatePositionInputs();
        
        // CORRECCIÓN: Llamar a updateContentHeight después de un breve delay
        setTimeout(updateContentHeight, 10);
        
        saveAction(actionInfo);
        
      } else {
        alert("Seleccione primero un elemento para eliminar.");
      }
    }

    function deleteSelectedCard() {
      if (activeEditable) {
        const card = activeEditable.closest('.card');
        if (card) {
          const cardWrapper = card.closest('.col, .movable-card-wrapper');
          if (cardWrapper) {
            const cardCopy = cardWrapper.cloneNode(true);
            
            const actionInfo = {
                type: 'deleteCard',
                element: cardCopy.outerHTML,
                parent: cardWrapper.parentElement.id || cardWrapper.parentElement.className,
                undo: function() {
                    if (cardWrapper.parentElement) {
                        cardWrapper.parentElement.appendChild(cardCopy);
                        if (isEditMode) {
                            if (cardCopy.classList.contains('movable-card-wrapper')) {
                                makeElementDraggableAndResizable(cardCopy);
                            }
                        }
                        updateContentHeight();
                    }
                },
                redo: function() {
                    if (cardCopy.parentElement) {
                        cardCopy.remove();
                        updateContentHeight();
                    }
                }
            };
            
            cardWrapper.remove();
            activeEditable = null;
            updatePositionInputs();
            
            // CORRECCIÓN: Llamar a updateContentHeight después de un breve delay
            setTimeout(updateContentHeight, 10);
            
            saveAction(actionInfo);
          }
        } else {
          alert("Seleccione primero una tarjeta para eliminar.");
        }
      } else {
        alert("Seleccione primero una tarjeta para eliminar.");
      }
    }

    // --- Teclas de acceso rápido ---
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' && isEditMode && activeEditable) {
            e.preventDefault();
            deleteSelectedElement();
        }
        
        if (e.ctrlKey && e.key === 'z' && isEditMode) {
            e.preventDefault();
            undoAction();
        }
        
        if (e.ctrlKey && e.key === 'y' && isEditMode) {
            e.preventDefault();
            redoAction();
        }
        
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;
        if (!isEditMode || !target) return;
        
        if (activeEditable.getAttribute('contenteditable') === 'true' && document.activeElement === activeEditable) return; 

        let currentLeft = parseFloat(target.style.left.replace('px', '')) || 0;
        let currentTop = parseFloat(target.style.top.replace('px', '')) || 0;
        let moved = false;

        switch (e.key) {
            case 'ArrowUp': currentTop -= MOVE_STEP; moved = true; break;
            case 'ArrowDown': currentTop += MOVE_STEP; moved = true; break;
            case 'ArrowLeft': currentLeft -= MOVE_STEP; moved = true; break;
            case 'ArrowRight': currentLeft += MOVE_STEP; moved = true; break;
        }

        if (moved) {
            e.preventDefault();
            
            currentLeft = Math.max(0, currentLeft);
            currentTop = Math.max(0, currentTop);
            
            target.style.left = `${currentLeft}px`;
            target.style.top = `${currentTop}px`;
            
            updatePositionInputs();
            updateContentHeight();
        }
    });

    // --- Lógica de Clic y Selección CORREGIDA para tarjetas personalizadas ---
    let lastClickTime = 0;
    let clickCount = 0;
    let isEditingText = false;

    document.addEventListener('click', function(e) {
      if (!isEditMode) {
          const card = e.target.closest('.card');
          if (card) {
               const link = card.dataset.cardLink;
               if (link) {
                   e.preventDefault();
                   e.stopPropagation();
                   navigateToCardLink(link);
               }
          }
          return;
      }
      
      const el = e.target.closest('.editable-text');
      const card = e.target.closest('.card'); 
      const cardWrapper = e.target.closest('.movable-card-wrapper');
      
      if (e.target.closest('#editSidebar')) return;

      const now = new Date().getTime();
      const timeDiff = now - lastClickTime;

      // CORRECCIÓN: Manejo mejorado para evitar que se pierda la selección
      if (activeEditable && activeEditable !== el) {
          const activeMovable = activeEditable.closest('.movable, .movable-card-wrapper');
          if (activeMovable && activeMovable !== e.target.closest('.movable, .movable-card-wrapper')) {
              // Solo desactivar si no estamos en medio de una edición de texto
              if (!isEditingText) {
                  setMovableTextEditMode(activeMovable, false);
              }
          }
      }
      
      // Manejo de enlaces de tarjetas
      if (card && !el) {
          e.stopPropagation();
          e.preventDefault();
          
          const currentLink = card.dataset.cardLink || '';
          const newLink = prompt("Introduce la URL o la ID de sección (#metas) para esta tarjeta:", currentLink);
          
          if (newLink !== null) { 
              card.dataset.cardLink = newLink.trim();
              if (newLink.trim() === '') {
                   card.classList.remove('active-editable');
              } else {
                   card.classList.add('active-editable'); 
                   alert(`Enlace guardado: ${newLink}`);
              }
          }
          
          if (activeEditable && !isEditingText) {
            activeEditable.classList.remove('active-editable');
            activeEditable = null;
          }
          updatePositionInputs();
          return;
      }
      
      // Manejo de clics en elementos editables
      if (el && activeEditable === el) {
          if (timeDiff < 300) { clickCount++; } else { clickCount = 1; }
      } else { clickCount = 1; }
      lastClickTime = now;

      // CORRECCIÓN: Manejo mejorado del doble clic
      if (el && clickCount >= 2) {
          e.preventDefault();
          e.stopPropagation();
          isEditingText = true;
          const targetMovable = el.closest('.movable, .movable-card-wrapper');
          if (targetMovable) { 
              setMovableTextEditMode(targetMovable, true); 
          } else { 
              el.setAttribute('contenteditable', 'true'); 
          }
          el.focus();
          clickCount = 0;
          return;
      }

      // CORRECCIÓN: Selección normal sin interrumpir la edición
      if (el && !isEditingText) {
        e.stopPropagation();

        if (activeEditable && activeEditable !== el) {
            activeEditable.classList.remove('active-editable');
        }
        
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });

        activeEditable = el;
        activeEditable.classList.add('active-editable');

        if (cardWrapper && cardWrapper.getAttribute('contenteditable') !== 'true') {
            setMovableTextEditMode(cardWrapper, false);
        }

        updatePositionInputs();
      } else if (!e.target.closest('.movable, .movable-card-wrapper') && !isEditingText) {
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false); 
            activeEditable = null;
            updatePositionInputs();
        }
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });
      }
    });

    document.addEventListener('dblclick', function(e) {
        if (!isEditMode) return;
        const el = e.target.closest('.editable-text');
        if (el) {
            e.preventDefault();
            isEditingText = true;
            const targetMovable = el.closest('.movable, .movable-card-wrapper');
            if (targetMovable) { 
                setMovableTextEditMode(targetMovable, true); 
            } else { 
                el.setAttribute('contenteditable', 'true'); 
            }
            el.focus();
        }
    });

    // CORRECCIÓN: Manejo mejorado del focusout
    document.addEventListener('focusout', function(e) {
        if (!isEditMode) return;
        const el = e.target;

        if (el && el.classList.contains('editable-text') && el.getAttribute('contenteditable') === 'true') {
            setTimeout(() => {
                const newFocus = document.activeElement;
                const sidebar = document.getElementById('editSidebar');
                const isSelectingFont = newFocus && newFocus.id === 'fontFamilySelect'; 
                const targetMovable = el.closest('.movable, .movable-card-wrapper');

                if (!sidebar.contains(newFocus) || isSelectingFont) {
                    if (targetMovable) { 
                        setMovableTextEditMode(targetMovable, false); 
                    } else { 
                        el.removeAttribute('contenteditable'); 
                    }
                    isEditingText = false;
                } else {
                    el.focus(); 
                    restoreSelection();
                }
            }, 100);
        }
    });

    // CORRECCIÓN: Manejo de eventos de teclado para mantener la selección
    document.addEventListener('keydown', function(e) {
        if (isEditingText && (e.key === 'Escape' || (e.ctrlKey && e.key === 's'))) {
            e.preventDefault();
            const el = document.activeElement;
            if (el && el.classList.contains('editable-text')) {
                const targetMovable = el.closest('.movable, .movable-card-wrapper');
                if (targetMovable) {
                    setMovableTextEditMode(targetMovable, false);
                } else {
                    el.removeAttribute('contenteditable');
                }
                isEditingText = false;
                el.blur();
            }
        }
    });

    // --- Lógica de Modo Edición y Login ---
    function unwrapCard(card) {
        const link = card.closest('.card-link');
        if (link && link.tagName === 'A') {
            const wrapper = link.closest('.col') || link.closest('.col-half') || link.closest('.movable-card-wrapper');
            if (wrapper) {
                 wrapper.insertBefore(card, link);
                 link.remove();
            }
        }
    }

    function wrapCardWithLink(card, url) {
        const wrapper = card.closest('.col') || card.closest('.col-half') || card.closest('.movable-card-wrapper');
        if (!wrapper) return;
        
        const existingLink = wrapper.querySelector('.card-link');
        if (existingLink) {
             existingLink.setAttribute('href', url);
        } else {
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('target', url.startsWith('#') ? '_self' : '_blank'); 
            link.className = 'card-link'; 
            
            wrapper.insertBefore(link, card);
            link.appendChild(card);
        }
    }

    function toggleEditMode() {
      if (!isLoggedIn) {
          alert("Debes iniciar sesión con una cuenta de Administrador para acceder al Modo Edición.");
          return;
      }
      isEditMode = !isEditMode;
      const allEditables = document.querySelectorAll('.editable-text');
      const cards = document.querySelectorAll('.card');
      const editButton = document.getElementById('editToggleBtn');
      const sidebar = document.getElementById('editSidebar');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      if (isEditMode) {
        editButton.classList.replace('btn-outline-light', 'btn-light');
        editButton.innerHTML = '<i class="fas fa-save me-1"></i> Guardar Cambios';
        
        const editIndicator = document.createElement('div');
        editIndicator.className = 'edit-mode-indicator';
        editIndicator.id = 'editModeIndicator';
        editIndicator.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición Activo';
        document.body.appendChild(editIndicator);
        
        allEditables.forEach(el => el.classList.add('active-editable'));

        cards.forEach(card => {
             unwrapCard(card);
             if (card.dataset.cardLink && card.dataset.cardLink.trim() !== '') {
                 card.classList.add('active-editable');
             }
        });
        
        sidebar.classList.remove('d-none-temp');
        mainContentWrapper.style.marginLeft = 'min(300px, 85vw)';
        
        initializeMovableElements();
        updateContentHeight();

      } else {
        editButton.classList.replace('btn-light', 'btn-outline-light');
        editButton.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición';
        
        const editIndicator = document.getElementById('editModeIndicator');
        if (editIndicator) editIndicator.remove();
        
        allEditables.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('active-editable');
        });
        
        initializeMovableElements(); 

        cards.forEach(card => {
            card.classList.remove('active-editable');
            const link = card.dataset.cardLink;
            if (link && link.trim() !== '') {
                wrapCardWithLink(card, link);
            }
        });

        if (activeEditable) activeEditable.classList.remove('active-editable');
        activeEditable = null;
        savedRange = null; 
        isEditingText = false;
        updatePositionInputs();
        
        sidebar.classList.add('d-none-temp');
        mainContentWrapper.style.marginLeft = '0';
        document.getElementById('mainContent').style.minHeight = 'auto';
        
        saveToSupabase();
      }
    }

    function handleLogin() {
      const emailInput = document.getElementById('inputEmail').value;
      const passwordInput = document.getElementById('inputPassword').value;
      if (emailInput === 'a@ug.com' && passwordInput === '1234') {
        isLoggedIn = true;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        document.getElementById('loginBtnContainer').classList.add('d-none');
        document.getElementById('userNav').classList.remove('d-none');
        document.getElementById('userNameDisplay').textContent = 'Administrador Daule';
        
        document.querySelectorAll('.restricted-nav').forEach(el => {
            el.classList.remove('restricted-nav');
            el.querySelector('.fa-lock').classList.add('d-none');
        });
        
        document.querySelectorAll('.card.restricted').forEach(card => {
            card.classList.remove('restricted');
        });
        
        loadFromSupabase();
        loadAppData();
        subscribeToChanges();

      } else {
          alert("Credenciales incorrectas. Inténtalo de nuevo.");
      }
    }
    
    function handleLogout() {
      if (isEditMode) toggleEditMode();
      isLoggedIn = false;
      document.getElementById('userNav').classList.add('d-none');
      document.getElementById('loginBtnContainer').classList.remove('d-none');

      document.querySelectorAll('.navbar-nav .nav-item a').forEach(el => {
          const sectionId = el.getAttribute('onclick').match(/'(.*?)'/)[1];
          if (RESTRICTED_SECTIONS.includes(sectionId)) {
               el.classList.add('restricted-nav');
               el.querySelector('.fa-lock').classList.remove('d-none');
          }
      });
      
      document.querySelectorAll('.card').forEach(card => {
          const link = card.dataset.cardLink;
          if (link && RESTRICTED_SECTIONS.includes(link.substring(1))) {
              card.classList.add('restricted');
          }
      });
      
      showSection('inicio');
    }

    // Inicialización al cargar la página 
    document.addEventListener('DOMContentLoaded', () => {
        showSection('inicio'); 
        addToNavigationHistory('inicio');
        
        if (isTouchDevice) {
            document.body.classList.add('touch-device');
        }
        
        // Cargar datos iniciales de Supabase
        loadFromSupabase();
        loadAppData();
    });

  </script>
</body>
</html>
